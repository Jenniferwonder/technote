import{createComponent,renderTemplate,maybeRenderHead,unescapeHTML}from"../../../../../chunks/1726310608649/astro.mjs";import"kleur/colors";import"clsx";import"html-escaper";import"cssesc";const id="front-end-frameworks/react/react-internal/react-internal.md",collection="posts",slug="front-end-frameworks/react/react-internal/react-internal",body="\n# React Internal\n\n[juejin.cn/post/7329780589061095434](https://juejin.cn/post/7329780589061095434)\n\n## Reverse Engineering\n\n[in Depth-level-up-your-reverse-engineering-skills](https://angularindepth.com/posts/1005/level-up-your-reverse-engineering-skills)  \n[in Depth-practical-application-of-reverse-engineering-guidelines-and-principles](https://angularindepth.com/posts/1006/practical-application-of-reverse-engineering-guidelines-and-principles)\n\n## Fiber\n\n[Lin Clark - A Cartoon Intro to Fiber - React Conf 2017 - YouTube](https://www.youtube.com/watch?v=ZCuYPiUIONs)\n[GitHub - acdlite/react-fiber-architecture: A description of React's new core algorithm, React Fiber](https://github.com/acdlite/react-fiber-architecture?source=post_page---------------------------) (Notes by Andrew Clark)\n\n### What is Fiber\n\nFiber å®é™…ä¸Šæ˜¯å¯¹ React è™šæ‹Ÿ DOM çš„æ¯ä¸ªèŠ‚ç‚¹çš„é‡æ–°å®ç°ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå®ƒå¯¹åº”ä¸€ä¸ª React å…ƒç´ ã€ç»„ä»¶å®ä¾‹æˆ– DOM èŠ‚ç‚¹ã€‚è¿™ä¸ªæ–°çš„ç»“æ„æ˜¯ä¸ªå•é“¾è¡¨çš„å½¢å¼ï¼Œå…è®¸ React åœ¨æ‰§è¡Œä¸­é€èŠ‚ç‚¹éå†å’Œæ“ä½œã€‚\næ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨çŠ¶æ€å’Œå¯¹å…¶ä»– Fiber èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œå¯¹å­èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ï¼‰ï¼Œä»¥åŠå¯¹å®é™… DOM èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚React å¯ä»¥ç‹¬ç«‹åœ°æ›´æ–°è¿™äº› Fiber èŠ‚ç‚¹ï¼Œè¿™æ˜¯ Fiber æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Œå®ƒå…è®¸**ä»»åŠ¡åˆ†å‰²å’Œä¸­æ–­**å·¥ä½œã€‚ä¸ºæœªæ¥çš„ React ç‰¹æ€§å’Œä¼˜åŒ–æä¾›äº†åŸºç¡€ï¼ŒåŒ…æ‹¬**å¼‚æ­¥æ¸²æŸ“å’Œå¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰**ï¼Œè¿™äº›éƒ½æ˜¯ React åº”ç”¨æœªæ¥æ€§èƒ½æå‡çš„å…³é”®æ–¹é¢ã€‚\n\n#### Why this name \"Fiber\"\n\nA fiber represents aÂ **unit of work**\nÂ Fiber is reimplementation of the stack, specialized for React components.\nÂ You can think of a single fiber as aÂ **virtual stack frame**\nIn order to use new Browser APIs ([Time-Slicing](react-internal%201.md#^u64q5e)) for scheduling update:\n\n- need a way to break rendering work into incremental units. If you rely only on the call stack, it will keep doing work until the stack is empty\n  So that we can\n- customize the behavior of the **call stack** to optimize for rendering UIs\n- interrupt the call stack at will and manipulate stack frames manually\n- canÂ [keep stack frames in memory](https://www.facebook.com/groups/2003630259862046/permalink/2054053404819731/)Â and execute them however (andÂ *whenever*) you want\n- potential for features such as concurrency and error boundaries\n\n#### Reconciliation\n\nä¸€ç§æ–°çš„è°ƒå’Œç®—æ³• (Reconciliation algorithm), reimplementation of React's core algorithm\nthe algorithm React uses to **diff** one tree with another to determine which parts need to be changed\nthe culmination of over two years of research by the React team\n\n#### Data Structure (List & Tree)\n\na plain JS object that\n\n- contains information about a component, its input, and its output\n- corresponds to a stack frame, but it also corresponds to an instance of a component\n- has an 1-to-1 relationship with a component instance (to manage work for an instance)\n\n```js\nconst fiber = {\n  stateNode // To manage its instance\n  child\n  return\n  sibling\n}\n```\n\n![image.png|275](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151445079.png)\n\n##### Important fields of a fiber\n\n| Fields                                                                                                        | For                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |\n| ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n| `type` & `key`                                                                                                | The type and key of a fiber serve the same purpose as they do for React elements. (In fact, when a fiber is created from an element, these two fields are copied over directly.)<br>The `type`Â describes the component that it corresponds to; <br>It's the function (as inÂ `v = f(d)`) whose execution is being tracked by the stack frame<br>The `key` is used during reconciliation to determine whether the fiber can be reused                                                                                                                                      |\n| `child`Â andÂ `sibling`                                                                                         | point to other fibers, describing the **recursive tree structure** of a fiber<br>The child fibers form a singly-linked list (å•å‘é“¾è¡¨) whose head is the first child                                                                                                                                                                                                                                                                                                                                                                                                     |\n| `return`                                                                                                      | The return fiber is the fiber to which the program should return after processing the current one. It is conceptually the same as the return address of a stack frame. It can also be thought of as the parent fiber.<br>If a fiber has multiple child fibers, each child fiber's return fiber is the parent.                                                                                                                                                                                                                                                            |\n| `pendingProps` and `memoizedProps`                                                                            | `pendingProps`Â are set at the beginning of the function execution, andÂ `memoizedProps`Â are set at the end.<br>When the incomingÂ `pendingProps`Â are equal toÂ `memoizedProps`, it signals that the fiber's previous output can be reused, preventing unnecessary work                                                                                                                                                                                                                                                                                                      |\n| `pendingWorkPriority` (New: FiberNode Implementations does not have any \"priorities\". instead it has \"Lanes\") | A number indicating the priority of the work represented by the fiber;<br>With the exception ofÂ `NoWork`, which is 0, a larger number indicates a lower priority.<br>The scheduler uses the priority field to search for the next unit of work to perform<br>`js<br>  /**<br>   * Each filer knows<br>   * 1. priorities for the work of itself - lanes<br>   * 2. priorities for the work of its descendant - childLanes<br>   */<br>  this.lanes = NoLanes;<br>  this.childLanes = NoLanes;<br>` <br>                                                                  |\n| `alternate`                                                                                                   | a component instance has at most two fibers that correspond to it: the current, flushed fiber, and the work-in-progress fiber;<br>The alternate of the current fiber is the work-in-progress, and the alternate of the work-in-progress is the current fiber.<br>A fiber's alternate is created lazily using a function calledÂ `cloneFiber`. Rather than always creating a new object,Â `cloneFiber`Â will attempt to reuse the fiber's alternate if it exists, minimizing allocations (Double buffering/ æ”¹å˜æŒ‡é’ˆæŒ‡å‘)                                                    |\n| `output`                                                                                                      | the output of a fiber is the return value of a function<br>Every fiber eventually has output, but output is created only at the leaf nodes byÂ **host components** (The leaf nodes of a React application. They are specific to the rendering environment (e.g., in a browser app, they are `div`, `span`, etc.)). The output is then transferred up the tree<br>The output is what is eventually given to the renderer so that it can flush the changes to the rendering environment. It's the renderer's responsibility to define how the output is created and updated |\n\nThe child fiber corresponds to the value returned by a component'sÂ `render`Â method. So in the following example\n\n```js\nfunction Parent() {\n  return <Child />;\n}\n```\n\nThe child fiber ofÂ `Parent`Â corresponds toÂ `Child`.\nThe sibling field accounts for the case whereÂ `render`Â returns multiple children (a new feature in Fiber!):\n\n```js\nfunction Parent() {\n  return [<Child1 />, <Child2 />];\n}\n```\n\n### Background\n\n[zhihu.com/question/31809713/answer/53544875](https://www.zhihu.com/question/31809713/answer/53544875)\n\n#### æ€æ‰‹çº§ç‰¹æ€§ (killer feature)\n\n- **Declarative:**Â React makes it painless to create interactive UIs. Design simple views for each state in your application, and React will efficiently update and render just the right components when your data changes. Declarative views make your code more predictable, simpler to understand, and easier to debug. (make UI coding easier (declarative instead of imperative))\n- **Component-Based:**Â Build encapsulated components that manage their own state, then compose them to make complex UIs. Since component logic is written in JavaScript instead of templates, you can easily pass rich data through your app and keep the state out of the DOM.\n- **Learn Once, Write Anywhere:**Â We don't make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code. React can also render on the server usingÂ [Node](https://nodejs.org/en)Â and power mobile apps usingÂ [React Native](https://reactnative.dev/).\n- The central idea of React's API is to think of updates as if they cause the entire app to re-render.\n\n#### Re-render\n\nA change in the data used to render a React app. Usually the result of `setState`. Eventually results in a re-render.\n\n#### Diff\n\n![image.png](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-diff.png)\n\n#### Reconciliation / Virtual DOM (è™šæ‹Ÿ DOM)\n\n> Virtual DOM æ˜¯ React çš„ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æŠ€æœ¯ç»†èŠ‚ï¼Œå®ƒä¹Ÿæ˜¯å‰ç«¯æ¸²æŸ“å’Œæ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚æ‰€ä»¥ï¼Œä½ æœ‰å¿…è¦è¦å¥½å¥½å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªæŠ€æœ¯çš„å®ç°åŸç†å’Œç®—æ³•ã€‚å½“ç„¶ï¼Œå‰ææ¡ä»¶æ˜¯ä½ éœ€è¦å­¦ä¹ è¿‡å‰é¢æˆ‘æ‰€æ¨èè¿‡çš„æµè§ˆå™¨çš„å·¥ä½œåŸç†ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¸é”™çš„æ–‡ç« å¯ä»¥å¸®ä½ å­¦ä¹ è¿™ä¸€æŠ€æœ¯ã€‚\n> è™šæ‹Ÿ DOMï¼ˆVirtual DOMï¼‰æ˜¯ä¸€ç§ **åœ¨å†…å­˜ä¸­è¡¨ç¤ºçœŸå® DOM çš„æ•°æ®ç»“æ„**ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯¹ DOM è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œçœŸå®çš„ DOMã€‚\n\n- Optimization for re-rendering\n- When the app is updated (usually viaÂ `setState`), a new tree is generated.\n- The new tree is diffed with the previous tree to compute which operations are needed to update the rendered app. ^a7iagv\n  - Different component types are assumed to generate substantially different trees. React will not attempt to diff them, but rather replace the old tree completely.\n  - Diffing of lists is performed using keys. Keys should be \"stable, predictable, and unique.\"\n\n##### Supports DOM, and iOS, Android via React Native\n\n| Reconciler                                                                                               | Renderer                                                                                                         |\n| -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |\n| only 1 reconciliation algorithm when download react (-> Rewritten to **Fiber reconciliation algorithm**) | pluggable (can work with other host platform besides DOM)                                                        |\n| does the work of computing which parts of a tree have changed                                            | uses that information to actually update the rendered app                                                        |\n|                                                                                                          | React DOM and React Native can use their own renderers while sharing the same reconciler, provided by React core |\n\n##### [ä½ çŸ¥é“ Virtual DOM çš„å·¥ä½œåŸç†å—ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/655)\n\n- [ä¸ºä½•è¯´è™šæ‹Ÿ DOM ä¼šæé«˜æ€§èƒ½ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/720)\n- [React çš„è™šæ‹Ÿ DOM å’Œ vue çš„è™šæ‹Ÿ DOM æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/617)\n  è™šæ‹Ÿ DOM çš„ä¸»è¦ä¼˜åŠ¿æ˜¯æ€§èƒ½æå‡ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n\n1. å‡å°‘ DOM æ“ä½œæ¬¡æ•°ï¼šçœŸå® DOM çš„æ“ä½œï¼ˆå¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å…ƒç´ ï¼‰é€šå¸¸æ¯”å†…å­˜æ“ä½œæ›´è€—æ—¶ã€‚è™šæ‹Ÿ DOM å…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­è¿›è¡Œå¤§é‡æ“ä½œï¼Œç„¶åä¸€æ¬¡æ€§å°†è¿™äº›æ“ä½œåº”ç”¨åˆ°çœŸå® DOM ä¸Šï¼Œå‡å°‘äº†å¯¹çœŸå® DOM çš„æ“ä½œæ¬¡æ•°ã€‚\n2. æœ€å°åŒ–æ›´æ–°èŒƒå›´ï¼šè™šæ‹Ÿ DOM ç»“åˆ diff ç®—æ³•ï¼Œå¯ä»¥æ‰¾å‡ºæ–°æ—§è™šæ‹Ÿ DOM ä¹‹é—´çš„å·®å¼‚ï¼Œä»è€Œä»…å¯¹æœ‰å·®å¼‚çš„éƒ¨åˆ†è¿›è¡ŒçœŸå® DOM çš„æ›´æ–°ã€‚è¿™å¯ä»¥å‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚\n3. æ‰¹é‡æ›´æ–°ï¼šå½“æœ‰å¤šä¸ªæ›´æ”¹éœ€è¦åº”ç”¨åˆ°çœŸå® DOM æ—¶ï¼Œè™šæ‹Ÿ DOM å¯ä»¥å°†è¿™äº›æ›´æ”¹åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°ã€‚è¿™æœ‰åŠ©äºé¿å…å› å¤šæ¬¡æ“ä½œå¯¼è‡´çš„å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰å’Œé‡ç»˜ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚\n4. æ›´å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ï¼šè™šæ‹Ÿ DOM ä¸ä»…å¯ä»¥è¡¨ç¤º Web é¡µé¢ä¸­çš„ DOMï¼Œè¿˜å¯ä»¥è¡¨ç¤ºå…¶ä»–å¹³å°çš„ UIï¼ˆä¾‹å¦‚ç§»åŠ¨åº”ç”¨æˆ–æ¡Œé¢åº”ç”¨ï¼‰ã€‚è¿™æ„å‘³ç€ä½¿ç”¨è™šæ‹Ÿ DOM çš„æ¡†æ¶ï¼ˆå¦‚ Vue æˆ– Reactï¼‰å¯ä»¥æ›´å®¹æ˜“åœ°å®ç°è·¨å¹³å°åº”ç”¨ç¨‹åºï¼Œè€Œä¸å¿…ä¸ºæ¯ä¸ªå¹³å°ç¼–å†™ç‰¹å®šçš„ä»£ç ã€‚  \n   è™šæ‹Ÿ DOM çš„æ€§èƒ½æå‡å¹¶éç»å¯¹ï¼Œå®ƒä¸»è¦é€‚ç”¨äºå¤§å‹åº”ç”¨å’Œé¢‘ç¹æ›´æ–°çš„åœºæ™¯ã€‚å¯¹äºç®€å•çš„åº”ç”¨æˆ–æ›´æ–°è¾ƒå°‘çš„æƒ…å†µï¼Œè™šæ‹Ÿ DOM å¯èƒ½å¸¦æ¥ä¸€å®šçš„å¼€é”€ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè™šæ‹Ÿ DOM æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥å‡å°‘çœŸå® DOM æ“ä½œï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚\n\n##### Pre-requisite\n\n- DOM: ![image.png|475](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406160709065.png)\n- ğŸ·ï¸Browser-æµè§ˆå™¨å·¥ä½œåŸç†\n\n##### Reference\n\n- [in Depth-how-virtual-dom-is-implemented-in-react](https://angularindepth.com/posts/1501/exploring-how-virtual-dom-is-implemented-in-react)\n- [How to write your own Virtual DOM | by deathmood | Medium](https://medium.com/@deathmood/how-to-write-your-own-virtual-dom-ee74acc13060)\n- [Write your Virtual DOM 2: Props & Events | by deathmood | Medium](https://medium.com/@deathmood/write-your-virtual-dom-2-props-events-a957608f5c76)\n- [How Virtual-DOM and diffing works in React | by Gethyl George Kurian | Medium](https://medium.com/@gethylgeorge/how-virtual-dom-and-diffing-works-in-react-6fc805f9f84e)\n- [The Inner Workings Of Virtual DOM | by rajaraodv | Medium](https://rajaraodv.medium.com/the-inner-workings-of-virtual-dom-666ee7ad47cf)\n- [æ·±åº¦å‰–æï¼šå¦‚ä½•å®ç°ä¸€ä¸ª Virtual DOM ç®—æ³• Â· Issue #13 Â· livoras/blog Â· GitHub](https://github.com/livoras/blog/issues/13)\n- ä¸¤ä¸ª Vitual-DOM å®ç°ä¾›ä½ å‚è€ƒ\n  - [GitHub - Matt-Esch/virtual-dom: A Virtual DOM and diffing algorithm](https://github.com/Matt-Esch/virtual-dom)\n  - [Maquette](https://maquettejs.org/)\n\n##### Questions\n\n- [è¯´è¯´ React diff çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/724)\n- [è¯´è¯´ä½ å¯¹ React çš„ reconciliationï¼ˆä¸€è‡´åŒ–ç®—æ³•ï¼‰çš„ç†è§£](https://github.com/haizlin/fe-interview/issues/870)\n- [React16 çš„ reconciliation å’Œ commit åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/711)\n\n### Goal of Fiber\n\nincrease react core algorithm's suitability for areas like animation, layout, and gestures\n**incremental rendering**: the ability to split rendering work into chunks and spread it out over multiple frames\n\n#### the ability to pause, abort, or reuse work as new updates come in\n\n- pause work and come back to it later.\n- reuse previously completed work.\n- abort work if it's no longer needed.\n\n#### the ability to assign priority to different types of updates\n\n### How Fiber works\n\n- how the **scheduler** finds the next unit of work to perform.\n- how **priority** is tracked and propagated through the fiber tree.\n- how the scheduler knows when to pause and resume work.\n- how work is flushed and marked as complete.\n- how side-effects (such as lifecycle methods) work.\n- what a coroutine is and how it can be used to implement features like context and layout.\n\n#### Comparison with old reconciler\n\n| Previous (Stack) Reconciler                                                                                                                        | Fiber Reconciler                                                                                                                                | How optimization happens                                                                                                                                                                                                                                                                                                                                                                                                |\n| -------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| element > instance > Dom node                                                                                                                      |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n| React walks the tree recursively and calls render functions of the whole updated tree during a single tick (main thread gets stuck)                | be able to break up & schedule high priority work to be handled before low priority work (start delaying some updates to avoid dropping frames) | Current Tree & workInProgress Tree                                                                                                                                                                                                                                                                                                                                                                                      |\n| ![image.png                                                                                                                                        | 200](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151436374.png)<br>                                                        | ![image.png                                                                                                                                                                                                                                                                                                                                                                                                             | 400](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151437675.png)<br> | **Phases**: <br>P1: render/ reconciliation (can be interrupted)<br>- `componentWillMount`<br>- `componentWillReceiveProps`<br>- `shouldComponentUpate`<br>- `componentWillUpdate`<br>P2: commit (can not be interrupted)<br>- `componentDidMount`<br>- `componentDidUpdate`<br>- `componentWillUnmount` |\n| make changes to the DOM node immediately when changes detected (before other updates are computed/ before calling render on other bottom elements) | Why? to avoid change DOM directly while computing changes to the tree                                                                           | **Schedule updates**: `requestIdleCallback()` <br>- Browser will let React know how much idle time it has to spare to commit updates<br>**work loop**: <br>- **next unit of work**: HostRoot (starts from HostRoot, <br> - if no updates it's gonna clone the node then continues to check its child )<br> - if updates exits, it's gonna tag the change to the workInProgress tree node<br>- **time remaining**: 13 ms |\n|                                                                                                                                                    | Enable error boundary                                                                                                                           | **Double buffering**: <br>when updates completed, react will switch pointer to the current tree and workInProgress tree                                                                                                                                                                                                                                                                                                 |\n|                                                                                                                                                    | Higher priority work will be handled before lower priority work                                                                                 | **Priority**<br>- High Priority: UI changes<br>- Low Priority: Data content changes from server <br>**Cooperative scheduling**<br>- Break work into small pieces of task, so that it can be paused                                                                                                                                                                                                                      |\n| render a single tree                                                                                                                               | steaming rendering                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n|                                                                                                                                                    | handle work in parallel                                                                                                                         | Split branches of the tree                                                                                                                                                                                                                                                                                                                                                                                              |\n|                                                                                                                                                    |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n\n#### Chunkingï¼ˆåˆ†åŒ…ï¼‰\n\nFiber æ¶æ„æŠŠæ¸²æŸ“å·¥ä½œæ‹†åˆ†æˆäº†å¤šä¸ªå°å—ï¼ˆchunksï¼‰ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨äº†ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚React æ¸²æŸ“æ—¶ï¼Œä¼šæŒ‰é¡ºåºéå† Fiber æ ‘ä¸­çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œä¸æ¯ä¸ªèŠ‚ç‚¹ç›¸å…³çš„å·¥ä½œã€‚\n![image.png](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-fiber.png)\n\n#### Double Buffering (åŒç¼“å†²)\n\nReact åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªæ ‘ç»“æ„ï¼šå½“å‰çš„æ ‘å’Œæ­£åœ¨å·¥ä½œçš„æ ‘ã€‚è¿™ä½¿å¾— React å¯ä»¥åœ¨ç”¨æˆ·ä¸å¯è§çš„åœ°æ–¹è¿›è¡Œå·¥ä½œï¼Œå¹¶ä¸”åªæœ‰å½“å·¥ä½œå®Œæˆå¹¶ä¸”æ•´ä¸ªæ ‘éƒ½å‡†å¤‡å¥½æ›´æ–°æ—¶ï¼Œæ‰ä¼šè¿›è¡Œæäº¤ã€‚\n\n\x3c!-- ![diff](react-internal%201.md#^a7iagv) --\x3e\n\n#### Priority\n\n[react/packages/scheduler/src/SchedulerPriorities.js at main Â· facebook/react Â· GitHub](https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerPriorities.js)\n\n- Different types of updates have different priorities â€” an animation update needs to complete more quickly than, say, an update from a data store.\n- **Immediate Priority**ï¼šç”¨äºä¸èƒ½ç­‰å¾…çš„å·¥ä½œï¼Œæ¯”å¦‚ç”±ç”¨æˆ·è¾“å…¥æˆ–åŠ¨ç”»è§¦å‘çš„æ›´æ–°ã€‚\n- **User Blocking Priority**ï¼šç”¨äºå¯èƒ½é˜»å¡ç”¨æˆ·æ“ä½œçš„å·¥ä½œã€‚\n- **Normal Priority**ï¼šç”¨äºæ­£å¸¸çš„æ•°æ®æŠ“å–ã€DOM æ›´æ–°ç­‰ã€‚\n- **Low Priority**ï¼šç”¨äºä¸æ€¥è¿«çš„ä»»åŠ¡ï¼Œå¯ä»¥æ¨è¿Ÿçš„å·¥ä½œï¼Œå¦‚æ—¥å¿—è®°å½•ã€‚\n- **Idle Priority**ï¼šç”¨äºå®Œå…¨ä¸ç´§æ€¥çš„ä»»åŠ¡ï¼Œåªæœ‰åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰æ‰§è¡Œï¼Œå¦‚ç¦»å±æ¸²æŸ“ã€‚\n\n#### Scheduler (è°ƒåº¦å™¨) / Concurrent Mode (å¹¶å‘æ¨¡å¼)\n\n> it's not necessary for every update to be applied immediately\n\nUnlike a push-based approach which requires the app (you, the programmer) to decide how to schedule work. A pull-based approach allows the framework (React) to be smart and make those decisions for you.\n_scheduling_\nthe process of determining when work should be performed.\n_work_\nany computations that must be performed. Work is usually the result of an update (e.g.Â `setState`).\nÂ [here](https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js?source=post_page---------------------------#L29-L28)Â you can see all types of work targets in Fiber\n\n##### MessageChannel\n\n`MessageChannel`Â API å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ª`MessagePort`å±æ€§å‘é€æ•°æ®ã€‚åœ¨ React çš„ä»»åŠ¡è°ƒåº¦å™¨ä¸­ï¼Œä½¿ç”¨`MessageChannel`ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ç§å¯ä»¥è·¨æµè§ˆå™¨å’Œç¯å¢ƒæŒç»­è¿è¡Œçš„â€œå¾®ä»»åŠ¡â€è°ƒåº¦ã€‚\nä½¿ç”¨`MessageChannel`å¯ä»¥ä½¿å¾— React åœ¨å¤„ç†å¦‚è¾“å…¥äº‹ä»¶ä¹‹åå°½å¿«è°ƒåº¦æ›´æ–°ï¼Œå› ä¸ºå®ƒå¯ä»¥å°†ä»»åŠ¡æ’é˜Ÿä¸ºå¾®ä»»åŠ¡ï¼Œè¿™äº›å¾®ä»»åŠ¡å°†åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåå°½å¿«æ‰§è¡Œï¼Œä½†åœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡å¼€å§‹ä¹‹å‰æ‰§è¡Œ\n\n##### Time Slicingï¼ˆæ—¶é—´åˆ†ç‰‡ï¼‰\n\nReact ä½¿ç”¨æµè§ˆå™¨çš„`requestIdleCallback`å’Œ`requestAnimationFrame`API æ¥æ‰§è¡Œæ—¶é—´åˆ†ç‰‡ã€‚ä½¿ç”¨`requestIdleCallback`å¯ä»¥è®© React åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œè€Œ`requestAnimationFrame`åˆ™ç”¨äºé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œå¦‚åŠ¨ç”»ã€‚ ^u64q5e\nReact å°†æ›´æ–°åˆ†è§£æˆå°çš„ä»»åŠ¡å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡å•å…ƒåœ¨æ‰§è¡Œæ—¶éƒ½ä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å°†æ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨ã€‚è¿™æ ·å¯ä»¥è®© React åœ¨æ‰§è¡Œå¤§é‡å·¥ä½œæ—¶ä»ç„¶èƒ½å¤Ÿå“åº”ç”¨æˆ·çš„äº¤äº’ã€‚\n\n###### å®ç°åŠŸèƒ½\n\nnon-blocking rendering\napplying updates based on the priority\npre-rendering content in the background\n\n#### ä½¿ç”¨ Concurrent Mode\n\nä¸ºäº†å¯ç”¨ Concurrent Modeï¼Œä½ éœ€è¦ä½¿ç”¨`React.createRoot`ä»£æ›¿`ReactDOM.render`æ¥åˆ›å»ºæ ¹èŠ‚ç‚¹\n\n```jsx\nimport React from \"react\";\nimport ReactDOM from \"react-dom\";\nconst root = ReactDOM.createRoot(document.getElementById(\"root\"));\nroot.render(<App />);\n```\n\n#### [React Fiber å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/858)\n\n#### [è¯´è¯´ä½ å¯¹ Fiber æ¶æ„çš„ç†è§£](https://github.com/haizlin/fe-interview/issues/700)\n\n- [Inside Fiber: in-depth overview of the new reconciliation algorithm in React | by Max Koretskyi | React In Depth | Medium](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)\n- [in Depth-inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react](https://angularindepth.com/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react)\n- [in Depth-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree](https://angularindepth.com/posts/1007/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree)\n\n### React 18 æ‰¹å¤„ç†\n\nåœ¨ React 18 ä¸­ï¼Œè‡ªåŠ¨æ‰¹å¤„ç†è¢«æ‰©å±•åˆ°æ›´å¤šçš„åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š\n\n- **Promise çš„è§£å†³å’Œæ‹’ç»å¤„ç†ç¨‹åº**ï¼šåœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œä¾‹å¦‚ Promise é“¾æˆ– async/await å‡½æ•°ä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè‡ªåŠ¨æ‰¹å¤„ç†ã€‚\n- **setTimeout å’Œ setInterval å›è°ƒ**ï¼šä½¿ç”¨è¿™äº›å®šæ—¶å™¨å‡½æ•°çš„å›è°ƒä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚\n- **åŸç”Ÿäº‹ä»¶å¤„ç†ç¨‹åº**ï¼šåœ¨é React åˆæˆäº‹ä»¶çš„ç›‘å¬å™¨ä¸­è¿›è¡Œçš„çŠ¶æ€æ›´æ–°ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚\n- **ä»»ä½•å…¶ä»–äº‹ä»¶å¾ªç¯ä¸­çš„äº‹ä»¶å¤„ç†**ï¼šå‡ ä¹æ‰€æœ‰çš„çŠ¶æ€æ›´æ–°ï¼Œä¸ç®¡å®ƒä»¬æ¥æºäºä»€ä¹ˆï¼Œåªè¦å®ƒä»¬åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ã€‚\n  React 18 æ‰¹å¤„ç†è‡ªåŠ¨æ‰¹å¤„ç†çš„å·¥ä½œåŸç†æ˜¯ React åœ¨æ‰§è¡Œæ›´æ–°æ—¶é‡‡ç”¨äº†ä¸€ç§æ‡’æƒ°çš„æ–¹å¼ï¼Œå®ƒä¼šå°†å¤šä¸ªæ›´æ–°ç´¯ç§¯èµ·æ¥ï¼Œç„¶åä¸€æ¬¡æ€§åº”ç”¨è¿™äº›æ›´æ–°ï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸ªæ›´æ–°ç«‹å³è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚è¿™å‡å°‘äº†é‡å¤çš„å·¥ä½œå’Œä¸å¿…è¦çš„ DOM æ›´æ–°ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚\n\n```jsx\n// å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªçŠ¶æ€æ›´æ–°å‡½æ•°\nconst [count, setCount] = useState(0);\nconst [flag, setFlag] = useState(false);\n// åœ¨ React 17 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šå¯¼è‡´ä¸¤æ¬¡é‡æ–°æ¸²æŸ“\nsetTimeout(() => {\n  setCount((c) => c + 1); // 1st re-render\n  setFlag((f) => !f); // 2nd re-render\n}, 1000);\n// åœ¨ React 18 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ä¸ºä¸€æ¬¡é‡æ–°æ¸²æŸ“\nsetTimeout(() => {\n  setCount((c) => c + 1); // Both updates are batched\n  setFlag((f) => !f); // into a single re-render\n}, 1000);\n```\n\n#### é€‰æ‹©æ€§æ‰¹å¤„ç†\n\nReact 18 æä¾›äº†Â `flushSync`Â å‡½æ•°ï¼Œå…è®¸ä½ é€‰æ‹©æ€§åœ°é€€å‡ºæ‰¹å¤„ç†ï¼Œå¯ä»¥ç¡®ä¿åœ¨å›è°ƒä¸­çš„æ›´æ–°ç«‹å³è¢«åº”ç”¨ï¼Œè§¦å‘åŒæ­¥çš„é‡æ–°æ¸²æŸ“\n\n```jsx\nimport { flushSync } from \"react-dom\";\n// åœ¨ flushSync çš„å›è°ƒä¸­çš„æ›´æ–°ä¸ä¼šæ‰¹å¤„ç†\nflushSync(() => {\n  setCount((c) => c + 1); // These updates are\n});\nflushSync(() => {\n  setFlag((f) => !f); // applied immediately\n});\n```\n\n## Questions\n\n#### [ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„ React å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/611)\n\n#### [ä½ é˜…è¯»äº†å‡ é React çš„æºç ï¼Ÿéƒ½æœ‰å“ªäº›æ”¶è·ï¼Ÿä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/879)\n\n#### [ä½ é˜…è¯»è¿‡ React çš„æºç å—ï¼Ÿç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹](https://github.com/haizlin/fe-interview/issues/654)\n\n#### [React æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„ DOM å…ƒç´ ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/663)\n\n#### è®²ä¸€ä¸‹ react çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯\n\n##### 1. çŠ¶æ€æ›´æ–°\n\nè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ä»ä¸€ä¸ªçŠ¶æ€æ›´æ–°å¼€å§‹ã€‚è¿™å¯èƒ½æ˜¯ç”±äºÂ `setState`ã€`useState`Â çš„ setter å‡½æ•°æˆ–Â `useReducer`Â çš„ dispatch è°ƒç”¨å¼•èµ·çš„ã€‚\nå½“çŠ¶æ€æ›´æ–°è¢«è§¦å‘æ—¶ï¼ŒReact ä¼šå°†è¯¥ç»„ä»¶æ ‡è®°ä¸ºéœ€è¦æ›´æ–°ã€‚\n\n##### 2. è°ƒåº¦æ›´æ–°\n\nReact çš„è°ƒåº¦å™¨æ¥æ”¶åˆ°æ›´æ–°è¯·æ±‚ï¼Œå¹¶æ ¹æ®å…¶ä¼˜å…ˆçº§å†³å®šä½•æ—¶æ‰§è¡Œæ›´æ–°ã€‚åœ¨ Concurrent Mode ä¸‹ï¼ŒReact å¯èƒ½ä¼šæ ¹æ®ä»»åŠ¡çš„ç´§æ€¥ç¨‹åº¦å’Œæµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ¥æ¨è¿Ÿæˆ–ä¸­æ–­æ›´æ–°ã€‚\n\n##### 3. åè°ƒï¼ˆReconciliationï¼‰\n\nåè°ƒè¿‡ç¨‹å¼€å§‹æ—¶ï¼ŒReact ä¼šä¸ºå½“å‰çš„æ›´æ–°åˆ›å»ºä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå¹¶å¼€å§‹éå†ç»„ä»¶æ ‘ï¼ˆä¹Ÿç§°ä¸º Fiber æ ‘ï¼‰ã€‚\n\n1. **æ¯”è¾ƒé˜¶æ®µ**ï¼šReact ä¼šæ¯”è¾ƒæ–°çš„ç»„ä»¶çŠ¶æ€å’Œä¸Šä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€ï¼Œè®¡ç®—å‡ºå®é™…éœ€è¦å˜æ›´çš„éƒ¨åˆ†ã€‚\n2. **ç”Ÿæˆ Fiber æ ‘**ï¼šReact ä¸ºæ¸²æŸ“ä¸­çš„æ¯ä¸ªç»„ä»¶åˆ›å»ºæˆ–æ›´æ–° Fiber èŠ‚ç‚¹ã€‚Fiber æ˜¯ React ç”¨äºè·Ÿè¸ªç»„ä»¶æ ‘ä¸­çš„æ¯ä¸ªç»„ä»¶çŠ¶æ€å’Œç»“æ„çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚\n\n##### 4. æ¸²æŸ“\n\nåœ¨åè°ƒè¿‡ç¨‹ä¸­ï¼ŒReact ä¸ºç»„ä»¶è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«æˆ–ç±»ç»„ä»¶çš„ `render` æ–¹æ³•ï¼‰ï¼Œç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOMï¼ˆReact å…ƒç´ ï¼‰ã€‚\n\n##### 5. æäº¤\n\nå½“åè°ƒå®Œæˆå¹¶ä¸” React å‡†å¤‡å¥½åº”ç”¨å˜æ›´åˆ°å®é™… DOM æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œæäº¤é˜¶æ®µã€‚\n\n1. **æ‰§è¡Œå‰¯ä½œç”¨**ï¼šåœ¨æäº¤é˜¶æ®µï¼ŒReact ä¼šæ‰§è¡Œ `useEffect`ã€`useLayoutEffect` ç­‰ Hook ä¸­çš„å‰¯ä½œç”¨å‡½æ•°ã€‚\n2. **æ›´æ–° DOM**ï¼šReact å°†æ›´æ–°è®¡ç®—å‡ºæ¥çš„å˜æ›´åº”ç”¨åˆ°å®é™…çš„ DOM ä¸Šã€‚è¿™å¯èƒ½åŒ…æ‹¬å±æ€§çš„æ›´æ–°ã€å…ƒç´ çš„æ·»åŠ æˆ–åˆ é™¤ç­‰ã€‚\n3. **å¼•ç”¨èµ‹å€¼**ï¼šReact ä¼šæ›´æ–°éœ€è¦å˜æ›´çš„ç»„ä»¶çš„å¼•ç”¨ï¼Œä¾‹å¦‚å°† DOM èŠ‚ç‚¹èµ‹å€¼ç»™é€šè¿‡ `useRef` åˆ›å»ºçš„ Refsã€‚\n\n##### 6. æ¸…ç†ä¸é€šçŸ¥\n\næœ€åï¼ŒReact æ¸…ç†ä¹‹å‰æ¸²æŸ“çš„çŠ¶æ€ã€æ‰§è¡Œå‰¯ä½œç”¨çš„æ¸…ç†å‡½æ•°ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šçŸ¥ç»„ä»¶æ›´æ–°å®Œæˆã€‚è¿™æ˜¯ä¸€ä¸ªæ¸…ç†å¹¶ä½¿ç³»ç»Ÿä¿æŒæœ€æ–°çŠ¶æ€çš„è¿‡ç¨‹ã€‚\n\n##### æ€è€ƒ\n\næ•´ä¸ªè¿‡ç¨‹æ˜¯é«˜åº¦ä¼˜åŒ–çš„ï¼Œæ¶‰åŠåˆ°äº†ä¸€ç³»åˆ—å¤æ‚çš„å†…éƒ¨æœºåˆ¶ã€‚React ä½¿ç”¨äº†å¦‚ Fiber æ¶æ„ã€åŒç¼“å†²ã€æ—¶é—´åˆ‡ç‰‡ç­‰æŠ€æœ¯ï¼Œä½¿å¾—å³ä½¿åœ¨å¤§è§„æ¨¡çš„æ›´æ–°ä¸­ä¹Ÿèƒ½ä¿æŒé«˜æ€§èƒ½å¹¶é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚\nåœ¨å®è·µä¸­ï¼ŒReact å¼€å‘è€…ä¸éœ€è¦æ·±å…¥äº†è§£æ‰€æœ‰å†…éƒ¨ç»†èŠ‚ï¼Œä½†ç†è§£çŠ¶æ€æ›´æ–°å’Œè§†å›¾æ›´æ–°ä¹‹é—´çš„åŸºæœ¬é“¾è·¯å¯¹äºç¼–å†™é«˜æ•ˆä¸”ç¬¦åˆé¢„æœŸçš„ä»£ç æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚\n",data={title:"react-internal",DateStarted:new Date(17165088e5),draft:!1,tags:["React"],category:"Front-End Frameworks"},_internal={type:"content",filePath:"E:/SynologyDrive/Codespace/blog-site/mynote/my-fuwari-blog/src/content/posts/front-end-frameworks/react/react-internal/react-internal.md",rawData:void 0},html='<h1 id="react-internal">React Internal<a class="anchor" href="#react-internal"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h1>\n<p><a href="https://juejin.cn/post/7329780589061095434">juejin.cn/post/7329780589061095434</a></p>\n<h2 id="reverse-engineering">Reverse Engineering<a class="anchor" href="#reverse-engineering"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h2>\n<p><a href="https://angularindepth.com/posts/1005/level-up-your-reverse-engineering-skills">in Depth-level-up-your-reverse-engineering-skills</a><br>\n<a href="https://angularindepth.com/posts/1006/practical-application-of-reverse-engineering-guidelines-and-principles">in Depth-practical-application-of-reverse-engineering-guidelines-and-principles</a></p>\n<h2 id="fiber">Fiber<a class="anchor" href="#fiber"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h2>\n<p><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs">Lin Clark - A Cartoon Intro to Fiber - React Conf 2017 - YouTube</a>\n<a href="https://github.com/acdlite/react-fiber-architecture?source=post_page---------------------------">GitHub - acdlite/react-fiber-architecture: A description of Reactâ€™s new core algorithm, React Fiber</a> (Notes by Andrew Clark)</p>\n<h3 id="what-is-fiber">What is Fiber<a class="anchor" href="#what-is-fiber"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h3>\n<p>Fiber å®é™…ä¸Šæ˜¯å¯¹ React è™šæ‹Ÿ DOM çš„æ¯ä¸ªèŠ‚ç‚¹çš„é‡æ–°å®ç°ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå®ƒå¯¹åº”ä¸€ä¸ª React å…ƒç´ ã€ç»„ä»¶å®ä¾‹æˆ– DOM èŠ‚ç‚¹ã€‚è¿™ä¸ªæ–°çš„ç»“æ„æ˜¯ä¸ªå•é“¾è¡¨çš„å½¢å¼ï¼Œå…è®¸ React åœ¨æ‰§è¡Œä¸­é€èŠ‚ç‚¹éå†å’Œæ“ä½œã€‚\næ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨çŠ¶æ€å’Œå¯¹å…¶ä»– Fiber èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œå¯¹å­èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ï¼‰ï¼Œä»¥åŠå¯¹å®é™… DOM èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚React å¯ä»¥ç‹¬ç«‹åœ°æ›´æ–°è¿™äº› Fiber èŠ‚ç‚¹ï¼Œè¿™æ˜¯ Fiber æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Œå®ƒå…è®¸<strong>ä»»åŠ¡åˆ†å‰²å’Œä¸­æ–­</strong>å·¥ä½œã€‚ä¸ºæœªæ¥çš„ React ç‰¹æ€§å’Œä¼˜åŒ–æä¾›äº†åŸºç¡€ï¼ŒåŒ…æ‹¬<strong>å¼‚æ­¥æ¸²æŸ“å’Œå¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰</strong>ï¼Œè¿™äº›éƒ½æ˜¯ React åº”ç”¨æœªæ¥æ€§èƒ½æå‡çš„å…³é”®æ–¹é¢ã€‚</p>\n<h4 id="why-this-name-fiber">Why this name â€œFiberâ€<a class="anchor" href="#why-this-name-fiber"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>A fiber represents aÂ <strong>unit of work</strong>\nÂ Fiber is reimplementation of the stack, specialized for React components.\nÂ You can think of a single fiber as aÂ <strong>virtual stack frame</strong>\nIn order to use new Browser APIs (<a href="react-internal%201.md#%5Eu64q5e">Time-Slicing</a>) for scheduling update:</p>\n<ul>\n<li>need a way to break rendering work into incremental units. If you rely only on the call stack, it will keep doing work until the stack is empty\nSo that we can</li>\n<li>customize the behavior of the <strong>call stack</strong> to optimize for rendering UIs</li>\n<li>interrupt the call stack at will and manipulate stack frames manually</li>\n<li>canÂ <a href="https://www.facebook.com/groups/2003630259862046/permalink/2054053404819731/">keep stack frames in memory</a>Â and execute them however (andÂ <em>whenever</em>) you want</li>\n<li>potential for features such as concurrency and error boundaries</li>\n</ul>\n<h4 id="reconciliation">Reconciliation<a class="anchor" href="#reconciliation"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>ä¸€ç§æ–°çš„è°ƒå’Œç®—æ³• (Reconciliation algorithm), reimplementation of Reactâ€™s core algorithm\nthe algorithm React uses to <strong>diff</strong> one tree with another to determine which parts need to be changed\nthe culmination of over two years of research by the React team</p>\n<h4 id="data-structure-list--tree">Data Structure (List &#x26; Tree)<a class="anchor" href="#data-structure-list--tree"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>a plain JS object that</p>\n<ul>\n<li>contains information about a component, its input, and its output</li>\n<li>corresponds to a stack frame, but it also corresponds to an instance of a component</li>\n<li>has an 1-to-1 relationship with a component instance (to manage work for an instance)</li>\n</ul>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> fiber</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>\n<span class="line"><span style="color:#E1E4E8">  stateNode </span><span style="color:#6A737D">// To manage its instance</span></span>\n<span class="line"><span style="color:#E1E4E8">  child</span></span>\n<span class="line"><span style="color:#E1E4E8">  return</span></span>\n<span class="line"><span style="color:#E1E4E8">  sibling</span></span>\n<span class="line"><span style="color:#E1E4E8">}</span></span>\n<span class="line"></span></code></pre>\n<p><img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151445079.png" alt="image.png|275"></p>\n<h5 id="important-fields-of-a-fiber">Important fields of a fiber<a class="anchor" href="#important-fields-of-a-fiber"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Fields</th><th>For</th></tr></thead><tbody><tr><td><code>type</code> &#x26; <code>key</code></td><td>The type and key of a fiber serve the same purpose as they do for React elements. (In fact, when a fiber is created from an element, these two fields are copied over directly.)<br>The <code>type</code>Â describes the component that it corresponds to; <br>Itâ€™s the function (as inÂ <code>v = f(d)</code>) whose execution is being tracked by the stack frame<br>The <code>key</code> is used during reconciliation to determine whether the fiber can be reused</td></tr><tr><td><code>child</code>Â andÂ <code>sibling</code></td><td>point to other fibers, describing the <strong>recursive tree structure</strong> of a fiber<br>The child fibers form a singly-linked list (å•å‘é“¾è¡¨) whose head is the first child</td></tr><tr><td><code>return</code></td><td>The return fiber is the fiber to which the program should return after processing the current one. It is conceptually the same as the return address of a stack frame. It can also be thought of as the parent fiber.<br>If a fiber has multiple child fibers, each child fiberâ€™s return fiber is the parent.</td></tr><tr><td><code>pendingProps</code> and <code>memoizedProps</code></td><td><code>pendingProps</code>Â are set at the beginning of the function execution, andÂ <code>memoizedProps</code>Â are set at the end.<br>When the incomingÂ <code>pendingProps</code>Â are equal toÂ <code>memoizedProps</code>, it signals that the fiberâ€™s previous output can be reused, preventing unnecessary work</td></tr><tr><td><code>pendingWorkPriority</code> (New: FiberNode Implementations does not have any â€œprioritiesâ€. instead it has â€œLanesâ€)</td><td>A number indicating the priority of the work represented by the fiber;<br>With the exception ofÂ <code>NoWork</code>, which is 0, a larger number indicates a lower priority.<br>The scheduler uses the priority field to search for the next unit of work to perform<br><code>js&#x3C;br>  /**&#x3C;br>   * Each filer knows&#x3C;br>   * 1. priorities for the work of itself - lanes&#x3C;br>   * 2. priorities for the work of its descendant - childLanes&#x3C;br>   */&#x3C;br>  this.lanes = NoLanes;&#x3C;br>  this.childLanes = NoLanes;&#x3C;br></code> <br></td></tr><tr><td><code>alternate</code></td><td>a component instance has at most two fibers that correspond to it: the current, flushed fiber, and the work-in-progress fiber;<br>The alternate of the current fiber is the work-in-progress, and the alternate of the work-in-progress is the current fiber.<br>A fiberâ€™s alternate is created lazily using a function calledÂ <code>cloneFiber</code>. Rather than always creating a new object,Â <code>cloneFiber</code>Â will attempt to reuse the fiberâ€™s alternate if it exists, minimizing allocations (Double buffering/ æ”¹å˜æŒ‡é’ˆæŒ‡å‘)</td></tr><tr><td><code>output</code></td><td>the output of a fiber is the return value of a function<br>Every fiber eventually has output, but output is created only at the leaf nodes byÂ <strong>host components</strong> (The leaf nodes of a React application. They are specific to the rendering environment (e.g., in a browser app, they are <code>div</code>, <code>span</code>, etc.)). The output is then transferred up the tree<br>The output is what is eventually given to the renderer so that it can flush the changes to the rendering environment. Itâ€™s the rendererâ€™s responsibility to define how the output is created and updated</td></tr></tbody></table>\n<p>The child fiber corresponds to the value returned by a componentâ€™sÂ <code>render</code>Â method. So in the following example</p>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> Parent</span><span style="color:#E1E4E8">() {</span></span>\n<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#79B8FF">Child</span><span style="color:#E1E4E8"> />;</span></span>\n<span class="line"><span style="color:#E1E4E8">}</span></span>\n<span class="line"></span></code></pre>\n<p>The child fiber ofÂ <code>Parent</code>Â corresponds toÂ <code>Child</code>.\nThe sibling field accounts for the case whereÂ <code>render</code>Â returns multiple children (a new feature in Fiber!):</p>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> Parent</span><span style="color:#E1E4E8">() {</span></span>\n<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> [&#x3C;</span><span style="color:#79B8FF">Child1</span><span style="color:#E1E4E8"> />, &#x3C;</span><span style="color:#79B8FF">Child2</span><span style="color:#E1E4E8"> />];</span></span>\n<span class="line"><span style="color:#E1E4E8">}</span></span>\n<span class="line"></span></code></pre>\n<h3 id="background">Background<a class="anchor" href="#background"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h3>\n<p><a href="https://www.zhihu.com/question/31809713/answer/53544875">zhihu.com/question/31809713/answer/53544875</a></p>\n<h4 id="æ€æ‰‹çº§ç‰¹æ€§-killer-feature">æ€æ‰‹çº§ç‰¹æ€§ (killer feature)<a class="anchor" href="#æ€æ‰‹çº§ç‰¹æ€§-killer-feature"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<ul>\n<li><strong>Declarative:</strong>Â React makes it painless to create interactive UIs. Design simple views for each state in your application, and React will efficiently update and render just the right components when your data changes. Declarative views make your code more predictable, simpler to understand, and easier to debug. (make UI coding easier (declarative instead of imperative))</li>\n<li><strong>Component-Based:</strong>Â Build encapsulated components that manage their own state, then compose them to make complex UIs. Since component logic is written in JavaScript instead of templates, you can easily pass rich data through your app and keep the state out of the DOM.</li>\n<li><strong>Learn Once, Write Anywhere:</strong>Â We donâ€™t make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code. React can also render on the server usingÂ <a href="https://nodejs.org/en">Node</a>Â and power mobile apps usingÂ <a href="https://reactnative.dev/">React Native</a>.</li>\n<li>The central idea of Reactâ€™s API is to think of updates as if they cause the entire app to re-render.</li>\n</ul>\n<h4 id="re-render">Re-render<a class="anchor" href="#re-render"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>A change in the data used to render a React app. Usually the result of <code>setState</code>. Eventually results in a re-render.</p>\n<h4 id="diff">Diff<a class="anchor" href="#diff"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p><img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-diff.png" alt="image.png"></p>\n<h4 id="reconciliation--virtual-dom-è™šæ‹Ÿ-dom">Reconciliation / Virtual DOM (è™šæ‹Ÿ DOM)<a class="anchor" href="#reconciliation--virtual-dom-è™šæ‹Ÿ-dom"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<blockquote>\n<p>Virtual DOM æ˜¯ React çš„ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æŠ€æœ¯ç»†èŠ‚ï¼Œå®ƒä¹Ÿæ˜¯å‰ç«¯æ¸²æŸ“å’Œæ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚æ‰€ä»¥ï¼Œä½ æœ‰å¿…è¦è¦å¥½å¥½å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªæŠ€æœ¯çš„å®ç°åŸç†å’Œç®—æ³•ã€‚å½“ç„¶ï¼Œå‰ææ¡ä»¶æ˜¯ä½ éœ€è¦å­¦ä¹ è¿‡å‰é¢æˆ‘æ‰€æ¨èè¿‡çš„æµè§ˆå™¨çš„å·¥ä½œåŸç†ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¸é”™çš„æ–‡ç« å¯ä»¥å¸®ä½ å­¦ä¹ è¿™ä¸€æŠ€æœ¯ã€‚\nè™šæ‹Ÿ DOMï¼ˆVirtual DOMï¼‰æ˜¯ä¸€ç§ <strong>åœ¨å†…å­˜ä¸­è¡¨ç¤ºçœŸå® DOM çš„æ•°æ®ç»“æ„</strong>ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯¹ DOM è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œçœŸå®çš„ DOMã€‚</p>\n</blockquote>\n<ul>\n<li>Optimization for re-rendering</li>\n<li>When the app is updated (usually viaÂ <code>setState</code>), a new tree is generated.</li>\n<li>The new tree is diffed with the previous tree to compute which operations are needed to update the rendered app. ^a7iagv\n<ul>\n<li>Different component types are assumed to generate substantially different trees. React will not attempt to diff them, but rather replace the old tree completely.</li>\n<li>Diffing of lists is performed using keys. Keys should be â€œstable, predictable, and unique.â€</li>\n</ul>\n</li>\n</ul>\n<h5 id="supports-dom-and-ios-android-via-react-native">Supports DOM, and iOS, Android via React Native<a class="anchor" href="#supports-dom-and-ios-android-via-react-native"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Reconciler</th><th>Renderer</th></tr></thead><tbody><tr><td>only 1 reconciliation algorithm when download react (-> Rewritten to <strong>Fiber reconciliation algorithm</strong>)</td><td>pluggable (can work with other host platform besides DOM)</td></tr><tr><td>does the work of computing which parts of a tree have changed</td><td>uses that information to actually update the rendered app</td></tr><tr><td></td><td>React DOM and React Native can use their own renderers while sharing the same reconciler, provided by React core</td></tr></tbody></table>\n<h5 id="ä½ çŸ¥é“-virtual-dom-çš„å·¥ä½œåŸç†å—"><a href="https://github.com/haizlin/fe-interview/issues/655">ä½ çŸ¥é“ Virtual DOM çš„å·¥ä½œåŸç†å—ï¼Ÿ</a><a class="anchor" href="#ä½ çŸ¥é“-virtual-dom-çš„å·¥ä½œåŸç†å—"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<ul>\n<li><a href="https://github.com/haizlin/fe-interview/issues/720">ä¸ºä½•è¯´è™šæ‹Ÿ DOM ä¼šæé«˜æ€§èƒ½ï¼Ÿ</a></li>\n<li><a href="https://github.com/haizlin/fe-interview/issues/617">React çš„è™šæ‹Ÿ DOM å’Œ vue çš„è™šæ‹Ÿ DOM æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a>\nè™šæ‹Ÿ DOM çš„ä¸»è¦ä¼˜åŠ¿æ˜¯æ€§èƒ½æå‡ï¼ŒåŸå› å¦‚ä¸‹ï¼š</li>\n</ul>\n<ol>\n<li>å‡å°‘ DOM æ“ä½œæ¬¡æ•°ï¼šçœŸå® DOM çš„æ“ä½œï¼ˆå¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å…ƒç´ ï¼‰é€šå¸¸æ¯”å†…å­˜æ“ä½œæ›´è€—æ—¶ã€‚è™šæ‹Ÿ DOM å…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­è¿›è¡Œå¤§é‡æ“ä½œï¼Œç„¶åä¸€æ¬¡æ€§å°†è¿™äº›æ“ä½œåº”ç”¨åˆ°çœŸå® DOM ä¸Šï¼Œå‡å°‘äº†å¯¹çœŸå® DOM çš„æ“ä½œæ¬¡æ•°ã€‚</li>\n<li>æœ€å°åŒ–æ›´æ–°èŒƒå›´ï¼šè™šæ‹Ÿ DOM ç»“åˆ diff ç®—æ³•ï¼Œå¯ä»¥æ‰¾å‡ºæ–°æ—§è™šæ‹Ÿ DOM ä¹‹é—´çš„å·®å¼‚ï¼Œä»è€Œä»…å¯¹æœ‰å·®å¼‚çš„éƒ¨åˆ†è¿›è¡ŒçœŸå® DOM çš„æ›´æ–°ã€‚è¿™å¯ä»¥å‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚</li>\n<li>æ‰¹é‡æ›´æ–°ï¼šå½“æœ‰å¤šä¸ªæ›´æ”¹éœ€è¦åº”ç”¨åˆ°çœŸå® DOM æ—¶ï¼Œè™šæ‹Ÿ DOM å¯ä»¥å°†è¿™äº›æ›´æ”¹åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°ã€‚è¿™æœ‰åŠ©äºé¿å…å› å¤šæ¬¡æ“ä½œå¯¼è‡´çš„å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰å’Œé‡ç»˜ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li>\n<li>æ›´å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ï¼šè™šæ‹Ÿ DOM ä¸ä»…å¯ä»¥è¡¨ç¤º Web é¡µé¢ä¸­çš„ DOMï¼Œè¿˜å¯ä»¥è¡¨ç¤ºå…¶ä»–å¹³å°çš„ UIï¼ˆä¾‹å¦‚ç§»åŠ¨åº”ç”¨æˆ–æ¡Œé¢åº”ç”¨ï¼‰ã€‚è¿™æ„å‘³ç€ä½¿ç”¨è™šæ‹Ÿ DOM çš„æ¡†æ¶ï¼ˆå¦‚ Vue æˆ– Reactï¼‰å¯ä»¥æ›´å®¹æ˜“åœ°å®ç°è·¨å¹³å°åº”ç”¨ç¨‹åºï¼Œè€Œä¸å¿…ä¸ºæ¯ä¸ªå¹³å°ç¼–å†™ç‰¹å®šçš„ä»£ç ã€‚<br>\nè™šæ‹Ÿ DOM çš„æ€§èƒ½æå‡å¹¶éç»å¯¹ï¼Œå®ƒä¸»è¦é€‚ç”¨äºå¤§å‹åº”ç”¨å’Œé¢‘ç¹æ›´æ–°çš„åœºæ™¯ã€‚å¯¹äºç®€å•çš„åº”ç”¨æˆ–æ›´æ–°è¾ƒå°‘çš„æƒ…å†µï¼Œè™šæ‹Ÿ DOM å¯èƒ½å¸¦æ¥ä¸€å®šçš„å¼€é”€ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè™šæ‹Ÿ DOM æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥å‡å°‘çœŸå® DOM æ“ä½œï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</li>\n</ol>\n<h5 id="pre-requisite">Pre-requisite<a class="anchor" href="#pre-requisite"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<ul>\n<li>DOM: <img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406160709065.png" alt="image.png|475"></li>\n<li>ğŸ·ï¸Browser-æµè§ˆå™¨å·¥ä½œåŸç†</li>\n</ul>\n<h5 id="reference">Reference<a class="anchor" href="#reference"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<ul>\n<li><a href="https://angularindepth.com/posts/1501/exploring-how-virtual-dom-is-implemented-in-react">in Depth-how-virtual-dom-is-implemented-in-react</a></li>\n<li><a href="https://medium.com/@deathmood/how-to-write-your-own-virtual-dom-ee74acc13060">How to write your own Virtual DOM | by deathmood | Medium</a></li>\n<li><a href="https://medium.com/@deathmood/write-your-virtual-dom-2-props-events-a957608f5c76">Write your Virtual DOM 2: Props &#x26; Events | by deathmood | Medium</a></li>\n<li><a href="https://medium.com/@gethylgeorge/how-virtual-dom-and-diffing-works-in-react-6fc805f9f84e">How Virtual-DOM and diffing works in React | by Gethyl George Kurian | Medium</a></li>\n<li><a href="https://rajaraodv.medium.com/the-inner-workings-of-virtual-dom-666ee7ad47cf">The Inner Workings Of Virtual DOM | by rajaraodv | Medium</a></li>\n<li><a href="https://github.com/livoras/blog/issues/13">æ·±åº¦å‰–æï¼šå¦‚ä½•å®ç°ä¸€ä¸ª Virtual DOM ç®—æ³• Â· Issue #13 Â· livoras/blog Â· GitHub</a></li>\n<li>ä¸¤ä¸ª Vitual-DOM å®ç°ä¾›ä½ å‚è€ƒ\n<ul>\n<li><a href="https://github.com/Matt-Esch/virtual-dom">GitHub - Matt-Esch/virtual-dom: A Virtual DOM and diffing algorithm</a></li>\n<li><a href="https://maquettejs.org/">Maquette</a></li>\n</ul>\n</li>\n</ul>\n<h5 id="questions">Questions<a class="anchor" href="#questions"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<ul>\n<li><a href="https://github.com/haizlin/fe-interview/issues/724">è¯´è¯´ React diff çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>\n<li><a href="https://github.com/haizlin/fe-interview/issues/870">è¯´è¯´ä½ å¯¹ React çš„ reconciliationï¼ˆä¸€è‡´åŒ–ç®—æ³•ï¼‰çš„ç†è§£</a></li>\n<li><a href="https://github.com/haizlin/fe-interview/issues/711">React16 çš„ reconciliation å’Œ commit åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>\n</ul>\n<h3 id="goal-of-fiber">Goal of Fiber<a class="anchor" href="#goal-of-fiber"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h3>\n<p>increase react core algorithmâ€™s suitability for areas like animation, layout, and gestures\n<strong>incremental rendering</strong>: the ability to split rendering work into chunks and spread it out over multiple frames</p>\n<h4 id="the-ability-to-pause-abort-or-reuse-work-as-new-updates-come-in">the ability to pause, abort, or reuse work as new updates come in<a class="anchor" href="#the-ability-to-pause-abort-or-reuse-work-as-new-updates-come-in"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<ul>\n<li>pause work and come back to it later.</li>\n<li>reuse previously completed work.</li>\n<li>abort work if itâ€™s no longer needed.</li>\n</ul>\n<h4 id="the-ability-to-assign-priority-to-different-types-of-updates">the ability to assign priority to different types of updates<a class="anchor" href="#the-ability-to-assign-priority-to-different-types-of-updates"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h3 id="how-fiber-works">How Fiber works<a class="anchor" href="#how-fiber-works"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h3>\n<ul>\n<li>how the <strong>scheduler</strong> finds the next unit of work to perform.</li>\n<li>how <strong>priority</strong> is tracked and propagated through the fiber tree.</li>\n<li>how the scheduler knows when to pause and resume work.</li>\n<li>how work is flushed and marked as complete.</li>\n<li>how side-effects (such as lifecycle methods) work.</li>\n<li>what a coroutine is and how it can be used to implement features like context and layout.</li>\n</ul>\n<h4 id="comparison-with-old-reconciler">Comparison with old reconciler<a class="anchor" href="#comparison-with-old-reconciler"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>| Previous (Stack) Reconciler                                                                                                                        | Fiber Reconciler                                                                                                                                | How optimization happens                                                                                                                                                                                                                                                                                                                                                                                                |\n| -------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| element > instance > Dom node                                                                                                                      |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n| React walks the tree recursively and calls render functions of the whole updated tree during a single tick (main thread gets stuck)                | be able to break up &#x26; schedule high priority work to be handled before low priority work (start delaying some updates to avoid dropping frames) | Current Tree &#x26; workInProgress Tree                                                                                                                                                                                                                                                                                                                                                                                      |\n| <img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151436374.png" alt="image.png                                                                                                                                        | 200"><br>                                                        | <img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151437675.png" alt="image.png                                                                                                                                                                                                                                                                                                                                                                                                             | 400"><br> | <strong>Phases</strong>: <br>P1: render/ reconciliation (can be interrupted)<br>- <code>componentWillMount</code><br>- <code>componentWillReceiveProps</code><br>- <code>shouldComponentUpate</code><br>- <code>componentWillUpdate</code><br>P2: commit (can not be interrupted)<br>- <code>componentDidMount</code><br>- <code>componentDidUpdate</code><br>- <code>componentWillUnmount</code> |\n| make changes to the DOM node immediately when changes detected (before other updates are computed/ before calling render on other bottom elements) | Why? to avoid change DOM directly while computing changes to the tree                                                                           | <strong>Schedule updates</strong>: <code>requestIdleCallback()</code> <br>- Browser will let React know how much idle time it has to spare to commit updates<br><strong>work loop</strong>: <br>- <strong>next unit of work</strong>: HostRoot (starts from HostRoot, <br> - if no updates itâ€™s gonna clone the node then continues to check its child )<br> - if updates exits, itâ€™s gonna tag the change to the workInProgress tree node<br>- <strong>time remaining</strong>: 13 ms |\n|                                                                                                                                                    | Enable error boundary                                                                                                                           | <strong>Double buffering</strong>: <br>when updates completed, react will switch pointer to the current tree and workInProgress tree                                                                                                                                                                                                                                                                                                 |\n|                                                                                                                                                    | Higher priority work will be handled before lower priority work                                                                                 | <strong>Priority</strong><br>- High Priority: UI changes<br>- Low Priority: Data content changes from server <br><strong>Cooperative scheduling</strong><br>- Break work into small pieces of task, so that it can be paused                                                                                                                                                                                                                      |\n| render a single tree                                                                                                                               | steaming rendering                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n|                                                                                                                                                    | handle work in parallel                                                                                                                         | Split branches of the tree                                                                                                                                                                                                                                                                                                                                                                                              |\n|                                                                                                                                                    |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |</p>\n<h4 id="chunkingåˆ†åŒ…">Chunkingï¼ˆåˆ†åŒ…ï¼‰<a class="anchor" href="#chunkingåˆ†åŒ…"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>Fiber æ¶æ„æŠŠæ¸²æŸ“å·¥ä½œæ‹†åˆ†æˆäº†å¤šä¸ªå°å—ï¼ˆchunksï¼‰ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨äº†ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚React æ¸²æŸ“æ—¶ï¼Œä¼šæŒ‰é¡ºåºéå† Fiber æ ‘ä¸­çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œä¸æ¯ä¸ªèŠ‚ç‚¹ç›¸å…³çš„å·¥ä½œã€‚\n<img src="https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-fiber.png" alt="image.png"></p>\n<h4 id="double-buffering-åŒç¼“å†²">Double Buffering (åŒç¼“å†²)<a class="anchor" href="#double-buffering-åŒç¼“å†²"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>React åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªæ ‘ç»“æ„ï¼šå½“å‰çš„æ ‘å’Œæ­£åœ¨å·¥ä½œçš„æ ‘ã€‚è¿™ä½¿å¾— React å¯ä»¥åœ¨ç”¨æˆ·ä¸å¯è§çš„åœ°æ–¹è¿›è¡Œå·¥ä½œï¼Œå¹¶ä¸”åªæœ‰å½“å·¥ä½œå®Œæˆå¹¶ä¸”æ•´ä¸ªæ ‘éƒ½å‡†å¤‡å¥½æ›´æ–°æ—¶ï¼Œæ‰ä¼šè¿›è¡Œæäº¤ã€‚</p>\n\x3c!-- ![diff](react-internal%201.md#^a7iagv) --\x3e\n<h4 id="priority">Priority<a class="anchor" href="#priority"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p><a href="https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerPriorities.js">react/packages/scheduler/src/SchedulerPriorities.js at main Â· facebook/react Â· GitHub</a></p>\n<ul>\n<li>Different types of updates have different priorities â€” an animation update needs to complete more quickly than, say, an update from a data store.</li>\n<li><strong>Immediate Priority</strong>ï¼šç”¨äºä¸èƒ½ç­‰å¾…çš„å·¥ä½œï¼Œæ¯”å¦‚ç”±ç”¨æˆ·è¾“å…¥æˆ–åŠ¨ç”»è§¦å‘çš„æ›´æ–°ã€‚</li>\n<li><strong>User Blocking Priority</strong>ï¼šç”¨äºå¯èƒ½é˜»å¡ç”¨æˆ·æ“ä½œçš„å·¥ä½œã€‚</li>\n<li><strong>Normal Priority</strong>ï¼šç”¨äºæ­£å¸¸çš„æ•°æ®æŠ“å–ã€DOM æ›´æ–°ç­‰ã€‚</li>\n<li><strong>Low Priority</strong>ï¼šç”¨äºä¸æ€¥è¿«çš„ä»»åŠ¡ï¼Œå¯ä»¥æ¨è¿Ÿçš„å·¥ä½œï¼Œå¦‚æ—¥å¿—è®°å½•ã€‚</li>\n<li><strong>Idle Priority</strong>ï¼šç”¨äºå®Œå…¨ä¸ç´§æ€¥çš„ä»»åŠ¡ï¼Œåªæœ‰åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰æ‰§è¡Œï¼Œå¦‚ç¦»å±æ¸²æŸ“ã€‚</li>\n</ul>\n<h4 id="scheduler-è°ƒåº¦å™¨--concurrent-mode-å¹¶å‘æ¨¡å¼">Scheduler (è°ƒåº¦å™¨) / Concurrent Mode (å¹¶å‘æ¨¡å¼)<a class="anchor" href="#scheduler-è°ƒåº¦å™¨--concurrent-mode-å¹¶å‘æ¨¡å¼"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<blockquote>\n<p>itâ€™s not necessary for every update to be applied immediately</p>\n</blockquote>\n<p>Unlike a push-based approach which requires the app (you, the programmer) to decide how to schedule work. A pull-based approach allows the framework (React) to be smart and make those decisions for you.\n<em>scheduling</em>\nthe process of determining when work should be performed.\n<em>work</em>\nany computations that must be performed. Work is usually the result of an update (e.g.Â <code>setState</code>).\nÂ <a href="https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js?source=post_page---------------------------#L29-L28">here</a>Â you can see all types of work targets in Fiber</p>\n<h5 id="messagechannel">MessageChannel<a class="anchor" href="#messagechannel"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p><code>MessageChannel</code>Â API å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ª<code>MessagePort</code>å±æ€§å‘é€æ•°æ®ã€‚åœ¨ React çš„ä»»åŠ¡è°ƒåº¦å™¨ä¸­ï¼Œä½¿ç”¨<code>MessageChannel</code>ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ç§å¯ä»¥è·¨æµè§ˆå™¨å’Œç¯å¢ƒæŒç»­è¿è¡Œçš„â€œå¾®ä»»åŠ¡â€è°ƒåº¦ã€‚\nä½¿ç”¨<code>MessageChannel</code>å¯ä»¥ä½¿å¾— React åœ¨å¤„ç†å¦‚è¾“å…¥äº‹ä»¶ä¹‹åå°½å¿«è°ƒåº¦æ›´æ–°ï¼Œå› ä¸ºå®ƒå¯ä»¥å°†ä»»åŠ¡æ’é˜Ÿä¸ºå¾®ä»»åŠ¡ï¼Œè¿™äº›å¾®ä»»åŠ¡å°†åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåå°½å¿«æ‰§è¡Œï¼Œä½†åœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡å¼€å§‹ä¹‹å‰æ‰§è¡Œ</p>\n<h5 id="time-slicingæ—¶é—´åˆ†ç‰‡">Time Slicingï¼ˆæ—¶é—´åˆ†ç‰‡ï¼‰<a class="anchor" href="#time-slicingæ—¶é—´åˆ†ç‰‡"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>React ä½¿ç”¨æµè§ˆå™¨çš„<code>requestIdleCallback</code>å’Œ<code>requestAnimationFrame</code>API æ¥æ‰§è¡Œæ—¶é—´åˆ†ç‰‡ã€‚ä½¿ç”¨<code>requestIdleCallback</code>å¯ä»¥è®© React åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œè€Œ<code>requestAnimationFrame</code>åˆ™ç”¨äºé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œå¦‚åŠ¨ç”»ã€‚ ^u64q5e\nReact å°†æ›´æ–°åˆ†è§£æˆå°çš„ä»»åŠ¡å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡å•å…ƒåœ¨æ‰§è¡Œæ—¶éƒ½ä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å°†æ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨ã€‚è¿™æ ·å¯ä»¥è®© React åœ¨æ‰§è¡Œå¤§é‡å·¥ä½œæ—¶ä»ç„¶èƒ½å¤Ÿå“åº”ç”¨æˆ·çš„äº¤äº’ã€‚</p>\n<h6 id="å®ç°åŠŸèƒ½">å®ç°åŠŸèƒ½<a class="anchor" href="#å®ç°åŠŸèƒ½"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h6>\n<p>non-blocking rendering\napplying updates based on the priority\npre-rendering content in the background</p>\n<h4 id="ä½¿ç”¨-concurrent-mode">ä½¿ç”¨ Concurrent Mode<a class="anchor" href="#ä½¿ç”¨-concurrent-mode"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>ä¸ºäº†å¯ç”¨ Concurrent Modeï¼Œä½ éœ€è¦ä½¿ç”¨<code>React.createRoot</code>ä»£æ›¿<code>ReactDOM.render</code>æ¥åˆ›å»ºæ ¹èŠ‚ç‚¹</p>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> React </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "react"</span><span style="color:#E1E4E8">;</span></span>\n<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> ReactDOM </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "react-dom"</span><span style="color:#E1E4E8">;</span></span>\n<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> root</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> ReactDOM.</span><span style="color:#B392F0">createRoot</span><span style="color:#E1E4E8">(document.</span><span style="color:#B392F0">getElementById</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"root"</span><span style="color:#E1E4E8">));</span></span>\n<span class="line"><span style="color:#E1E4E8">root.</span><span style="color:#B392F0">render</span><span style="color:#E1E4E8">(&#x3C;</span><span style="color:#79B8FF">App</span><span style="color:#E1E4E8"> />);</span></span>\n<span class="line"></span></code></pre>\n<h4 id="react-fiber-å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜"><a href="https://github.com/haizlin/fe-interview/issues/858">React Fiber å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</a><a class="anchor" href="#react-fiber-å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h4 id="è¯´è¯´ä½ å¯¹-fiber-æ¶æ„çš„ç†è§£"><a href="https://github.com/haizlin/fe-interview/issues/700">è¯´è¯´ä½ å¯¹ Fiber æ¶æ„çš„ç†è§£</a><a class="anchor" href="#è¯´è¯´ä½ å¯¹-fiber-æ¶æ„çš„ç†è§£"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<ul>\n<li><a href="https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e">Inside Fiber: in-depth overview of the new reconciliation algorithm in React | by Max Koretskyi | React In Depth | Medium</a></li>\n<li><a href="https://angularindepth.com/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react">in Depth-inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react</a></li>\n<li><a href="https://angularindepth.com/posts/1007/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree">in Depth-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree</a></li>\n</ul>\n<h3 id="react-18-æ‰¹å¤„ç†">React 18 æ‰¹å¤„ç†<a class="anchor" href="#react-18-æ‰¹å¤„ç†"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h3>\n<p>åœ¨ React 18 ä¸­ï¼Œè‡ªåŠ¨æ‰¹å¤„ç†è¢«æ‰©å±•åˆ°æ›´å¤šçš„åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š</p>\n<ul>\n<li><strong>Promise çš„è§£å†³å’Œæ‹’ç»å¤„ç†ç¨‹åº</strong>ï¼šåœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œä¾‹å¦‚ Promise é“¾æˆ– async/await å‡½æ•°ä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè‡ªåŠ¨æ‰¹å¤„ç†ã€‚</li>\n<li><strong>setTimeout å’Œ setInterval å›è°ƒ</strong>ï¼šä½¿ç”¨è¿™äº›å®šæ—¶å™¨å‡½æ•°çš„å›è°ƒä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚</li>\n<li><strong>åŸç”Ÿäº‹ä»¶å¤„ç†ç¨‹åº</strong>ï¼šåœ¨é React åˆæˆäº‹ä»¶çš„ç›‘å¬å™¨ä¸­è¿›è¡Œçš„çŠ¶æ€æ›´æ–°ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚</li>\n<li><strong>ä»»ä½•å…¶ä»–äº‹ä»¶å¾ªç¯ä¸­çš„äº‹ä»¶å¤„ç†</strong>ï¼šå‡ ä¹æ‰€æœ‰çš„çŠ¶æ€æ›´æ–°ï¼Œä¸ç®¡å®ƒä»¬æ¥æºäºä»€ä¹ˆï¼Œåªè¦å®ƒä»¬åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ã€‚\nReact 18 æ‰¹å¤„ç†è‡ªåŠ¨æ‰¹å¤„ç†çš„å·¥ä½œåŸç†æ˜¯ React åœ¨æ‰§è¡Œæ›´æ–°æ—¶é‡‡ç”¨äº†ä¸€ç§æ‡’æƒ°çš„æ–¹å¼ï¼Œå®ƒä¼šå°†å¤šä¸ªæ›´æ–°ç´¯ç§¯èµ·æ¥ï¼Œç„¶åä¸€æ¬¡æ€§åº”ç”¨è¿™äº›æ›´æ–°ï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸ªæ›´æ–°ç«‹å³è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚è¿™å‡å°‘äº†é‡å¤çš„å·¥ä½œå’Œä¸å¿…è¦çš„ DOM æ›´æ–°ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚</li>\n</ul>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D">// å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªçŠ¶æ€æ›´æ–°å‡½æ•°</span></span>\n<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">count</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">setCount</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> useState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>\n<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">flag</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">setFlag</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> useState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">);</span></span>\n<span class="line"><span style="color:#6A737D">// åœ¨ React 17 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šå¯¼è‡´ä¸¤æ¬¡é‡æ–°æ¸²æŸ“</span></span>\n<span class="line"><span style="color:#B392F0">setTimeout</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>\n<span class="line"><span style="color:#B392F0">  setCount</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">c</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// 1st re-render</span></span>\n<span class="line"><span style="color:#B392F0">  setFlag</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">f); </span><span style="color:#6A737D">// 2nd re-render</span></span>\n<span class="line"><span style="color:#E1E4E8">}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">);</span></span>\n<span class="line"><span style="color:#6A737D">// åœ¨ React 18 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ä¸ºä¸€æ¬¡é‡æ–°æ¸²æŸ“</span></span>\n<span class="line"><span style="color:#B392F0">setTimeout</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>\n<span class="line"><span style="color:#B392F0">  setCount</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">c</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// Both updates are batched</span></span>\n<span class="line"><span style="color:#B392F0">  setFlag</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">f); </span><span style="color:#6A737D">// into a single re-render</span></span>\n<span class="line"><span style="color:#E1E4E8">}, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">);</span></span>\n<span class="line"></span></code></pre>\n<h4 id="é€‰æ‹©æ€§æ‰¹å¤„ç†">é€‰æ‹©æ€§æ‰¹å¤„ç†<a class="anchor" href="#é€‰æ‹©æ€§æ‰¹å¤„ç†"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<p>React 18 æä¾›äº†Â <code>flushSync</code>Â å‡½æ•°ï¼Œå…è®¸ä½ é€‰æ‹©æ€§åœ°é€€å‡ºæ‰¹å¤„ç†ï¼Œå¯ä»¥ç¡®ä¿åœ¨å›è°ƒä¸­çš„æ›´æ–°ç«‹å³è¢«åº”ç”¨ï¼Œè§¦å‘åŒæ­¥çš„é‡æ–°æ¸²æŸ“</p>\n<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { flushSync } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> "react-dom"</span><span style="color:#E1E4E8">;</span></span>\n<span class="line"><span style="color:#6A737D">// åœ¨ flushSync çš„å›è°ƒä¸­çš„æ›´æ–°ä¸ä¼šæ‰¹å¤„ç†</span></span>\n<span class="line"><span style="color:#B392F0">flushSync</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>\n<span class="line"><span style="color:#B392F0">  setCount</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">c</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// These updates are</span></span>\n<span class="line"><span style="color:#E1E4E8">});</span></span>\n<span class="line"><span style="color:#B392F0">flushSync</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>\n<span class="line"><span style="color:#B392F0">  setFlag</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">f); </span><span style="color:#6A737D">// applied immediately</span></span>\n<span class="line"><span style="color:#E1E4E8">});</span></span>\n<span class="line"></span></code></pre>\n<h2 id="questions-1">Questions<a class="anchor" href="#questions-1"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h2>\n<h4 id="ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„-react-å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ"><a href="https://github.com/haizlin/fe-interview/issues/611">ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„ React å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a><a class="anchor" href="#ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„-react-å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h4 id="ä½ é˜…è¯»äº†å‡ é-react-çš„æºç éƒ½æœ‰å“ªäº›æ”¶è·ä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„"><a href="https://github.com/haizlin/fe-interview/issues/879">ä½ é˜…è¯»äº†å‡ é React çš„æºç ï¼Ÿéƒ½æœ‰å“ªäº›æ”¶è·ï¼Ÿä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„ï¼Ÿ</a><a class="anchor" href="#ä½ é˜…è¯»äº†å‡ é-react-çš„æºç éƒ½æœ‰å“ªäº›æ”¶è·ä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h4 id="ä½ é˜…è¯»è¿‡-react-çš„æºç å—ç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹"><a href="https://github.com/haizlin/fe-interview/issues/654">ä½ é˜…è¯»è¿‡ React çš„æºç å—ï¼Ÿç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹</a><a class="anchor" href="#ä½ é˜…è¯»è¿‡-react-çš„æºç å—ç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h4 id="react-æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„-dom-å…ƒç´ "><a href="https://github.com/haizlin/fe-interview/issues/663">React æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„ DOM å…ƒç´ ï¼Ÿ</a><a class="anchor" href="#react-æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„-dom-å…ƒç´ "><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h4 id="è®²ä¸€ä¸‹-react-çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯">è®²ä¸€ä¸‹ react çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯<a class="anchor" href="#è®²ä¸€ä¸‹-react-çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h4>\n<h5 id="1-çŠ¶æ€æ›´æ–°">1. çŠ¶æ€æ›´æ–°<a class="anchor" href="#1-çŠ¶æ€æ›´æ–°"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>è¿™ä¸ªè¿‡ç¨‹é€šå¸¸ä»ä¸€ä¸ªçŠ¶æ€æ›´æ–°å¼€å§‹ã€‚è¿™å¯èƒ½æ˜¯ç”±äºÂ <code>setState</code>ã€<code>useState</code>Â çš„ setter å‡½æ•°æˆ–Â <code>useReducer</code>Â çš„ dispatch è°ƒç”¨å¼•èµ·çš„ã€‚\nå½“çŠ¶æ€æ›´æ–°è¢«è§¦å‘æ—¶ï¼ŒReact ä¼šå°†è¯¥ç»„ä»¶æ ‡è®°ä¸ºéœ€è¦æ›´æ–°ã€‚</p>\n<h5 id="2-è°ƒåº¦æ›´æ–°">2. è°ƒåº¦æ›´æ–°<a class="anchor" href="#2-è°ƒåº¦æ›´æ–°"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>React çš„è°ƒåº¦å™¨æ¥æ”¶åˆ°æ›´æ–°è¯·æ±‚ï¼Œå¹¶æ ¹æ®å…¶ä¼˜å…ˆçº§å†³å®šä½•æ—¶æ‰§è¡Œæ›´æ–°ã€‚åœ¨ Concurrent Mode ä¸‹ï¼ŒReact å¯èƒ½ä¼šæ ¹æ®ä»»åŠ¡çš„ç´§æ€¥ç¨‹åº¦å’Œæµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ¥æ¨è¿Ÿæˆ–ä¸­æ–­æ›´æ–°ã€‚</p>\n<h5 id="3-åè°ƒreconciliation">3. åè°ƒï¼ˆReconciliationï¼‰<a class="anchor" href="#3-åè°ƒreconciliation"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>åè°ƒè¿‡ç¨‹å¼€å§‹æ—¶ï¼ŒReact ä¼šä¸ºå½“å‰çš„æ›´æ–°åˆ›å»ºä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå¹¶å¼€å§‹éå†ç»„ä»¶æ ‘ï¼ˆä¹Ÿç§°ä¸º Fiber æ ‘ï¼‰ã€‚</p>\n<ol>\n<li><strong>æ¯”è¾ƒé˜¶æ®µ</strong>ï¼šReact ä¼šæ¯”è¾ƒæ–°çš„ç»„ä»¶çŠ¶æ€å’Œä¸Šä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€ï¼Œè®¡ç®—å‡ºå®é™…éœ€è¦å˜æ›´çš„éƒ¨åˆ†ã€‚</li>\n<li><strong>ç”Ÿæˆ Fiber æ ‘</strong>ï¼šReact ä¸ºæ¸²æŸ“ä¸­çš„æ¯ä¸ªç»„ä»¶åˆ›å»ºæˆ–æ›´æ–° Fiber èŠ‚ç‚¹ã€‚Fiber æ˜¯ React ç”¨äºè·Ÿè¸ªç»„ä»¶æ ‘ä¸­çš„æ¯ä¸ªç»„ä»¶çŠ¶æ€å’Œç»“æ„çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚</li>\n</ol>\n<h5 id="4-æ¸²æŸ“">4. æ¸²æŸ“<a class="anchor" href="#4-æ¸²æŸ“"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>åœ¨åè°ƒè¿‡ç¨‹ä¸­ï¼ŒReact ä¸ºç»„ä»¶è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«æˆ–ç±»ç»„ä»¶çš„ <code>render</code> æ–¹æ³•ï¼‰ï¼Œç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOMï¼ˆReact å…ƒç´ ï¼‰ã€‚</p>\n<h5 id="5-æäº¤">5. æäº¤<a class="anchor" href="#5-æäº¤"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>å½“åè°ƒå®Œæˆå¹¶ä¸” React å‡†å¤‡å¥½åº”ç”¨å˜æ›´åˆ°å®é™… DOM æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œæäº¤é˜¶æ®µã€‚</p>\n<ol>\n<li><strong>æ‰§è¡Œå‰¯ä½œç”¨</strong>ï¼šåœ¨æäº¤é˜¶æ®µï¼ŒReact ä¼šæ‰§è¡Œ <code>useEffect</code>ã€<code>useLayoutEffect</code> ç­‰ Hook ä¸­çš„å‰¯ä½œç”¨å‡½æ•°ã€‚</li>\n<li><strong>æ›´æ–° DOM</strong>ï¼šReact å°†æ›´æ–°è®¡ç®—å‡ºæ¥çš„å˜æ›´åº”ç”¨åˆ°å®é™…çš„ DOM ä¸Šã€‚è¿™å¯èƒ½åŒ…æ‹¬å±æ€§çš„æ›´æ–°ã€å…ƒç´ çš„æ·»åŠ æˆ–åˆ é™¤ç­‰ã€‚</li>\n<li><strong>å¼•ç”¨èµ‹å€¼</strong>ï¼šReact ä¼šæ›´æ–°éœ€è¦å˜æ›´çš„ç»„ä»¶çš„å¼•ç”¨ï¼Œä¾‹å¦‚å°† DOM èŠ‚ç‚¹èµ‹å€¼ç»™é€šè¿‡ <code>useRef</code> åˆ›å»ºçš„ Refsã€‚</li>\n</ol>\n<h5 id="6-æ¸…ç†ä¸é€šçŸ¥">6. æ¸…ç†ä¸é€šçŸ¥<a class="anchor" href="#6-æ¸…ç†ä¸é€šçŸ¥"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>æœ€åï¼ŒReact æ¸…ç†ä¹‹å‰æ¸²æŸ“çš„çŠ¶æ€ã€æ‰§è¡Œå‰¯ä½œç”¨çš„æ¸…ç†å‡½æ•°ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šçŸ¥ç»„ä»¶æ›´æ–°å®Œæˆã€‚è¿™æ˜¯ä¸€ä¸ªæ¸…ç†å¹¶ä½¿ç³»ç»Ÿä¿æŒæœ€æ–°çŠ¶æ€çš„è¿‡ç¨‹ã€‚</p>\n<h5 id="æ€è€ƒ">æ€è€ƒ<a class="anchor" href="#æ€è€ƒ"><span class="anchor-icon" data-pagefind-ignore="">#</span></a></h5>\n<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯é«˜åº¦ä¼˜åŒ–çš„ï¼Œæ¶‰åŠåˆ°äº†ä¸€ç³»åˆ—å¤æ‚çš„å†…éƒ¨æœºåˆ¶ã€‚React ä½¿ç”¨äº†å¦‚ Fiber æ¶æ„ã€åŒç¼“å†²ã€æ—¶é—´åˆ‡ç‰‡ç­‰æŠ€æœ¯ï¼Œä½¿å¾—å³ä½¿åœ¨å¤§è§„æ¨¡çš„æ›´æ–°ä¸­ä¹Ÿèƒ½ä¿æŒé«˜æ€§èƒ½å¹¶é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚\nåœ¨å®è·µä¸­ï¼ŒReact å¼€å‘è€…ä¸éœ€è¦æ·±å…¥äº†è§£æ‰€æœ‰å†…éƒ¨ç»†èŠ‚ï¼Œä½†ç†è§£çŠ¶æ€æ›´æ–°å’Œè§†å›¾æ›´æ–°ä¹‹é—´çš„åŸºæœ¬é“¾è·¯å¯¹äºç¼–å†™é«˜æ•ˆä¸”ç¬¦åˆé¢„æœŸçš„ä»£ç æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚</p>',frontmatter={title:"react-internal",topic:["React"],type:"D",tags:["React"],category:"Front-End Frameworks",Datereviewed:null,reviewed:null,difficulty:null,status:null,comment:null,draft:!1,DateStarted:"2024-05-24T00:00:00.000Z",DateModified:"2024-09-14T00:00:00.000Z",minutes:22,words:4366},file="E:/SynologyDrive/Codespace/blog-site/mynote/my-fuwari-blog/src/content/posts/front-end-frameworks/react/react-internal/react-internal.md",url=void 0;function rawContent(){return"\n# React Internal\n\n[juejin.cn/post/7329780589061095434](https://juejin.cn/post/7329780589061095434)\n\n## Reverse Engineering\n\n[in Depth-level-up-your-reverse-engineering-skills](https://angularindepth.com/posts/1005/level-up-your-reverse-engineering-skills)  \n[in Depth-practical-application-of-reverse-engineering-guidelines-and-principles](https://angularindepth.com/posts/1006/practical-application-of-reverse-engineering-guidelines-and-principles)\n\n## Fiber\n\n[Lin Clark - A Cartoon Intro to Fiber - React Conf 2017 - YouTube](https://www.youtube.com/watch?v=ZCuYPiUIONs)\n[GitHub - acdlite/react-fiber-architecture: A description of React's new core algorithm, React Fiber](https://github.com/acdlite/react-fiber-architecture?source=post_page---------------------------) (Notes by Andrew Clark)\n\n### What is Fiber\n\nFiber å®é™…ä¸Šæ˜¯å¯¹ React è™šæ‹Ÿ DOM çš„æ¯ä¸ªèŠ‚ç‚¹çš„é‡æ–°å®ç°ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå®ƒå¯¹åº”ä¸€ä¸ª React å…ƒç´ ã€ç»„ä»¶å®ä¾‹æˆ– DOM èŠ‚ç‚¹ã€‚è¿™ä¸ªæ–°çš„ç»“æ„æ˜¯ä¸ªå•é“¾è¡¨çš„å½¢å¼ï¼Œå…è®¸ React åœ¨æ‰§è¡Œä¸­é€èŠ‚ç‚¹éå†å’Œæ“ä½œã€‚\næ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨çŠ¶æ€å’Œå¯¹å…¶ä»– Fiber èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œå¯¹å­èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ï¼‰ï¼Œä»¥åŠå¯¹å®é™… DOM èŠ‚ç‚¹çš„å¼•ç”¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚React å¯ä»¥ç‹¬ç«‹åœ°æ›´æ–°è¿™äº› Fiber èŠ‚ç‚¹ï¼Œè¿™æ˜¯ Fiber æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Œå®ƒå…è®¸**ä»»åŠ¡åˆ†å‰²å’Œä¸­æ–­**å·¥ä½œã€‚ä¸ºæœªæ¥çš„ React ç‰¹æ€§å’Œä¼˜åŒ–æä¾›äº†åŸºç¡€ï¼ŒåŒ…æ‹¬**å¼‚æ­¥æ¸²æŸ“å’Œå¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰**ï¼Œè¿™äº›éƒ½æ˜¯ React åº”ç”¨æœªæ¥æ€§èƒ½æå‡çš„å…³é”®æ–¹é¢ã€‚\n\n#### Why this name \"Fiber\"\n\nA fiber represents aÂ **unit of work**\nÂ Fiber is reimplementation of the stack, specialized for React components.\nÂ You can think of a single fiber as aÂ **virtual stack frame**\nIn order to use new Browser APIs ([Time-Slicing](react-internal%201.md#^u64q5e)) for scheduling update:\n\n- need a way to break rendering work into incremental units. If you rely only on the call stack, it will keep doing work until the stack is empty\n  So that we can\n- customize the behavior of the **call stack** to optimize for rendering UIs\n- interrupt the call stack at will and manipulate stack frames manually\n- canÂ [keep stack frames in memory](https://www.facebook.com/groups/2003630259862046/permalink/2054053404819731/)Â and execute them however (andÂ *whenever*) you want\n- potential for features such as concurrency and error boundaries\n\n#### Reconciliation\n\nä¸€ç§æ–°çš„è°ƒå’Œç®—æ³• (Reconciliation algorithm), reimplementation of React's core algorithm\nthe algorithm React uses to **diff** one tree with another to determine which parts need to be changed\nthe culmination of over two years of research by the React team\n\n#### Data Structure (List & Tree)\n\na plain JS object that\n\n- contains information about a component, its input, and its output\n- corresponds to a stack frame, but it also corresponds to an instance of a component\n- has an 1-to-1 relationship with a component instance (to manage work for an instance)\n\n```js\nconst fiber = {\n  stateNode // To manage its instance\n  child\n  return\n  sibling\n}\n```\n\n![image.png|275](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151445079.png)\n\n##### Important fields of a fiber\n\n| Fields                                                                                                        | For                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |\n| ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n| `type` & `key`                                                                                                | The type and key of a fiber serve the same purpose as they do for React elements. (In fact, when a fiber is created from an element, these two fields are copied over directly.)<br>The `type`Â describes the component that it corresponds to; <br>It's the function (as inÂ `v = f(d)`) whose execution is being tracked by the stack frame<br>The `key` is used during reconciliation to determine whether the fiber can be reused                                                                                                                                      |\n| `child`Â andÂ `sibling`                                                                                         | point to other fibers, describing the **recursive tree structure** of a fiber<br>The child fibers form a singly-linked list (å•å‘é“¾è¡¨) whose head is the first child                                                                                                                                                                                                                                                                                                                                                                                                     |\n| `return`                                                                                                      | The return fiber is the fiber to which the program should return after processing the current one. It is conceptually the same as the return address of a stack frame. It can also be thought of as the parent fiber.<br>If a fiber has multiple child fibers, each child fiber's return fiber is the parent.                                                                                                                                                                                                                                                            |\n| `pendingProps` and `memoizedProps`                                                                            | `pendingProps`Â are set at the beginning of the function execution, andÂ `memoizedProps`Â are set at the end.<br>When the incomingÂ `pendingProps`Â are equal toÂ `memoizedProps`, it signals that the fiber's previous output can be reused, preventing unnecessary work                                                                                                                                                                                                                                                                                                      |\n| `pendingWorkPriority` (New: FiberNode Implementations does not have any \"priorities\". instead it has \"Lanes\") | A number indicating the priority of the work represented by the fiber;<br>With the exception ofÂ `NoWork`, which is 0, a larger number indicates a lower priority.<br>The scheduler uses the priority field to search for the next unit of work to perform<br>`js<br>  /**<br>   * Each filer knows<br>   * 1. priorities for the work of itself - lanes<br>   * 2. priorities for the work of its descendant - childLanes<br>   */<br>  this.lanes = NoLanes;<br>  this.childLanes = NoLanes;<br>` <br>                                                                  |\n| `alternate`                                                                                                   | a component instance has at most two fibers that correspond to it: the current, flushed fiber, and the work-in-progress fiber;<br>The alternate of the current fiber is the work-in-progress, and the alternate of the work-in-progress is the current fiber.<br>A fiber's alternate is created lazily using a function calledÂ `cloneFiber`. Rather than always creating a new object,Â `cloneFiber`Â will attempt to reuse the fiber's alternate if it exists, minimizing allocations (Double buffering/ æ”¹å˜æŒ‡é’ˆæŒ‡å‘)                                                    |\n| `output`                                                                                                      | the output of a fiber is the return value of a function<br>Every fiber eventually has output, but output is created only at the leaf nodes byÂ **host components** (The leaf nodes of a React application. They are specific to the rendering environment (e.g., in a browser app, they are `div`, `span`, etc.)). The output is then transferred up the tree<br>The output is what is eventually given to the renderer so that it can flush the changes to the rendering environment. It's the renderer's responsibility to define how the output is created and updated |\n\nThe child fiber corresponds to the value returned by a component'sÂ `render`Â method. So in the following example\n\n```js\nfunction Parent() {\n  return <Child />;\n}\n```\n\nThe child fiber ofÂ `Parent`Â corresponds toÂ `Child`.\nThe sibling field accounts for the case whereÂ `render`Â returns multiple children (a new feature in Fiber!):\n\n```js\nfunction Parent() {\n  return [<Child1 />, <Child2 />];\n}\n```\n\n### Background\n\n[zhihu.com/question/31809713/answer/53544875](https://www.zhihu.com/question/31809713/answer/53544875)\n\n#### æ€æ‰‹çº§ç‰¹æ€§ (killer feature)\n\n- **Declarative:**Â React makes it painless to create interactive UIs. Design simple views for each state in your application, and React will efficiently update and render just the right components when your data changes. Declarative views make your code more predictable, simpler to understand, and easier to debug. (make UI coding easier (declarative instead of imperative))\n- **Component-Based:**Â Build encapsulated components that manage their own state, then compose them to make complex UIs. Since component logic is written in JavaScript instead of templates, you can easily pass rich data through your app and keep the state out of the DOM.\n- **Learn Once, Write Anywhere:**Â We don't make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code. React can also render on the server usingÂ [Node](https://nodejs.org/en)Â and power mobile apps usingÂ [React Native](https://reactnative.dev/).\n- The central idea of React's API is to think of updates as if they cause the entire app to re-render.\n\n#### Re-render\n\nA change in the data used to render a React app. Usually the result of `setState`. Eventually results in a re-render.\n\n#### Diff\n\n![image.png](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-diff.png)\n\n#### Reconciliation / Virtual DOM (è™šæ‹Ÿ DOM)\n\n> Virtual DOM æ˜¯ React çš„ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æŠ€æœ¯ç»†èŠ‚ï¼Œå®ƒä¹Ÿæ˜¯å‰ç«¯æ¸²æŸ“å’Œæ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚æ‰€ä»¥ï¼Œä½ æœ‰å¿…è¦è¦å¥½å¥½å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªæŠ€æœ¯çš„å®ç°åŸç†å’Œç®—æ³•ã€‚å½“ç„¶ï¼Œå‰ææ¡ä»¶æ˜¯ä½ éœ€è¦å­¦ä¹ è¿‡å‰é¢æˆ‘æ‰€æ¨èè¿‡çš„æµè§ˆå™¨çš„å·¥ä½œåŸç†ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¸é”™çš„æ–‡ç« å¯ä»¥å¸®ä½ å­¦ä¹ è¿™ä¸€æŠ€æœ¯ã€‚\n> è™šæ‹Ÿ DOMï¼ˆVirtual DOMï¼‰æ˜¯ä¸€ç§ **åœ¨å†…å­˜ä¸­è¡¨ç¤ºçœŸå® DOM çš„æ•°æ®ç»“æ„**ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­å¯¹ DOM è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œçœŸå®çš„ DOMã€‚\n\n- Optimization for re-rendering\n- When the app is updated (usually viaÂ `setState`), a new tree is generated.\n- The new tree is diffed with the previous tree to compute which operations are needed to update the rendered app. ^a7iagv\n  - Different component types are assumed to generate substantially different trees. React will not attempt to diff them, but rather replace the old tree completely.\n  - Diffing of lists is performed using keys. Keys should be \"stable, predictable, and unique.\"\n\n##### Supports DOM, and iOS, Android via React Native\n\n| Reconciler                                                                                               | Renderer                                                                                                         |\n| -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |\n| only 1 reconciliation algorithm when download react (-> Rewritten to **Fiber reconciliation algorithm**) | pluggable (can work with other host platform besides DOM)                                                        |\n| does the work of computing which parts of a tree have changed                                            | uses that information to actually update the rendered app                                                        |\n|                                                                                                          | React DOM and React Native can use their own renderers while sharing the same reconciler, provided by React core |\n\n##### [ä½ çŸ¥é“ Virtual DOM çš„å·¥ä½œåŸç†å—ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/655)\n\n- [ä¸ºä½•è¯´è™šæ‹Ÿ DOM ä¼šæé«˜æ€§èƒ½ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/720)\n- [React çš„è™šæ‹Ÿ DOM å’Œ vue çš„è™šæ‹Ÿ DOM æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/617)\n  è™šæ‹Ÿ DOM çš„ä¸»è¦ä¼˜åŠ¿æ˜¯æ€§èƒ½æå‡ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n\n1. å‡å°‘ DOM æ“ä½œæ¬¡æ•°ï¼šçœŸå® DOM çš„æ“ä½œï¼ˆå¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å…ƒç´ ï¼‰é€šå¸¸æ¯”å†…å­˜æ“ä½œæ›´è€—æ—¶ã€‚è™šæ‹Ÿ DOM å…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­è¿›è¡Œå¤§é‡æ“ä½œï¼Œç„¶åä¸€æ¬¡æ€§å°†è¿™äº›æ“ä½œåº”ç”¨åˆ°çœŸå® DOM ä¸Šï¼Œå‡å°‘äº†å¯¹çœŸå® DOM çš„æ“ä½œæ¬¡æ•°ã€‚\n2. æœ€å°åŒ–æ›´æ–°èŒƒå›´ï¼šè™šæ‹Ÿ DOM ç»“åˆ diff ç®—æ³•ï¼Œå¯ä»¥æ‰¾å‡ºæ–°æ—§è™šæ‹Ÿ DOM ä¹‹é—´çš„å·®å¼‚ï¼Œä»è€Œä»…å¯¹æœ‰å·®å¼‚çš„éƒ¨åˆ†è¿›è¡ŒçœŸå® DOM çš„æ›´æ–°ã€‚è¿™å¯ä»¥å‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚\n3. æ‰¹é‡æ›´æ–°ï¼šå½“æœ‰å¤šä¸ªæ›´æ”¹éœ€è¦åº”ç”¨åˆ°çœŸå® DOM æ—¶ï¼Œè™šæ‹Ÿ DOM å¯ä»¥å°†è¿™äº›æ›´æ”¹åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°ã€‚è¿™æœ‰åŠ©äºé¿å…å› å¤šæ¬¡æ“ä½œå¯¼è‡´çš„å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰å’Œé‡ç»˜ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚\n4. æ›´å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ï¼šè™šæ‹Ÿ DOM ä¸ä»…å¯ä»¥è¡¨ç¤º Web é¡µé¢ä¸­çš„ DOMï¼Œè¿˜å¯ä»¥è¡¨ç¤ºå…¶ä»–å¹³å°çš„ UIï¼ˆä¾‹å¦‚ç§»åŠ¨åº”ç”¨æˆ–æ¡Œé¢åº”ç”¨ï¼‰ã€‚è¿™æ„å‘³ç€ä½¿ç”¨è™šæ‹Ÿ DOM çš„æ¡†æ¶ï¼ˆå¦‚ Vue æˆ– Reactï¼‰å¯ä»¥æ›´å®¹æ˜“åœ°å®ç°è·¨å¹³å°åº”ç”¨ç¨‹åºï¼Œè€Œä¸å¿…ä¸ºæ¯ä¸ªå¹³å°ç¼–å†™ç‰¹å®šçš„ä»£ç ã€‚  \n   è™šæ‹Ÿ DOM çš„æ€§èƒ½æå‡å¹¶éç»å¯¹ï¼Œå®ƒä¸»è¦é€‚ç”¨äºå¤§å‹åº”ç”¨å’Œé¢‘ç¹æ›´æ–°çš„åœºæ™¯ã€‚å¯¹äºç®€å•çš„åº”ç”¨æˆ–æ›´æ–°è¾ƒå°‘çš„æƒ…å†µï¼Œè™šæ‹Ÿ DOM å¯èƒ½å¸¦æ¥ä¸€å®šçš„å¼€é”€ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè™šæ‹Ÿ DOM æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥å‡å°‘çœŸå® DOM æ“ä½œï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚\n\n##### Pre-requisite\n\n- DOM: ![image.png|475](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406160709065.png)\n- ğŸ·ï¸Browser-æµè§ˆå™¨å·¥ä½œåŸç†\n\n##### Reference\n\n- [in Depth-how-virtual-dom-is-implemented-in-react](https://angularindepth.com/posts/1501/exploring-how-virtual-dom-is-implemented-in-react)\n- [How to write your own Virtual DOM | by deathmood | Medium](https://medium.com/@deathmood/how-to-write-your-own-virtual-dom-ee74acc13060)\n- [Write your Virtual DOM 2: Props & Events | by deathmood | Medium](https://medium.com/@deathmood/write-your-virtual-dom-2-props-events-a957608f5c76)\n- [How Virtual-DOM and diffing works in React | by Gethyl George Kurian | Medium](https://medium.com/@gethylgeorge/how-virtual-dom-and-diffing-works-in-react-6fc805f9f84e)\n- [The Inner Workings Of Virtual DOM | by rajaraodv | Medium](https://rajaraodv.medium.com/the-inner-workings-of-virtual-dom-666ee7ad47cf)\n- [æ·±åº¦å‰–æï¼šå¦‚ä½•å®ç°ä¸€ä¸ª Virtual DOM ç®—æ³• Â· Issue #13 Â· livoras/blog Â· GitHub](https://github.com/livoras/blog/issues/13)\n- ä¸¤ä¸ª Vitual-DOM å®ç°ä¾›ä½ å‚è€ƒ\n  - [GitHub - Matt-Esch/virtual-dom: A Virtual DOM and diffing algorithm](https://github.com/Matt-Esch/virtual-dom)\n  - [Maquette](https://maquettejs.org/)\n\n##### Questions\n\n- [è¯´è¯´ React diff çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/724)\n- [è¯´è¯´ä½ å¯¹ React çš„ reconciliationï¼ˆä¸€è‡´åŒ–ç®—æ³•ï¼‰çš„ç†è§£](https://github.com/haizlin/fe-interview/issues/870)\n- [React16 çš„ reconciliation å’Œ commit åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/711)\n\n### Goal of Fiber\n\nincrease react core algorithm's suitability for areas like animation, layout, and gestures\n**incremental rendering**: the ability to split rendering work into chunks and spread it out over multiple frames\n\n#### the ability to pause, abort, or reuse work as new updates come in\n\n- pause work and come back to it later.\n- reuse previously completed work.\n- abort work if it's no longer needed.\n\n#### the ability to assign priority to different types of updates\n\n### How Fiber works\n\n- how the **scheduler** finds the next unit of work to perform.\n- how **priority** is tracked and propagated through the fiber tree.\n- how the scheduler knows when to pause and resume work.\n- how work is flushed and marked as complete.\n- how side-effects (such as lifecycle methods) work.\n- what a coroutine is and how it can be used to implement features like context and layout.\n\n#### Comparison with old reconciler\n\n| Previous (Stack) Reconciler                                                                                                                        | Fiber Reconciler                                                                                                                                | How optimization happens                                                                                                                                                                                                                                                                                                                                                                                                |\n| -------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| element > instance > Dom node                                                                                                                      |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n| React walks the tree recursively and calls render functions of the whole updated tree during a single tick (main thread gets stuck)                | be able to break up & schedule high priority work to be handled before low priority work (start delaying some updates to avoid dropping frames) | Current Tree & workInProgress Tree                                                                                                                                                                                                                                                                                                                                                                                      |\n| ![image.png                                                                                                                                        | 200](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151436374.png)<br>                                                        | ![image.png                                                                                                                                                                                                                                                                                                                                                                                                             | 400](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/202406151437675.png)<br> | **Phases**: <br>P1: render/ reconciliation (can be interrupted)<br>- `componentWillMount`<br>- `componentWillReceiveProps`<br>- `shouldComponentUpate`<br>- `componentWillUpdate`<br>P2: commit (can not be interrupted)<br>- `componentDidMount`<br>- `componentDidUpdate`<br>- `componentWillUnmount` |\n| make changes to the DOM node immediately when changes detected (before other updates are computed/ before calling render on other bottom elements) | Why? to avoid change DOM directly while computing changes to the tree                                                                           | **Schedule updates**: `requestIdleCallback()` <br>- Browser will let React know how much idle time it has to spare to commit updates<br>**work loop**: <br>- **next unit of work**: HostRoot (starts from HostRoot, <br> - if no updates it's gonna clone the node then continues to check its child )<br> - if updates exits, it's gonna tag the change to the workInProgress tree node<br>- **time remaining**: 13 ms |\n|                                                                                                                                                    | Enable error boundary                                                                                                                           | **Double buffering**: <br>when updates completed, react will switch pointer to the current tree and workInProgress tree                                                                                                                                                                                                                                                                                                 |\n|                                                                                                                                                    | Higher priority work will be handled before lower priority work                                                                                 | **Priority**<br>- High Priority: UI changes<br>- Low Priority: Data content changes from server <br>**Cooperative scheduling**<br>- Break work into small pieces of task, so that it can be paused                                                                                                                                                                                                                      |\n| render a single tree                                                                                                                               | steaming rendering                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n|                                                                                                                                                    | handle work in parallel                                                                                                                         | Split branches of the tree                                                                                                                                                                                                                                                                                                                                                                                              |\n|                                                                                                                                                    |                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |\n\n#### Chunkingï¼ˆåˆ†åŒ…ï¼‰\n\nFiber æ¶æ„æŠŠæ¸²æŸ“å·¥ä½œæ‹†åˆ†æˆäº†å¤šä¸ªå°å—ï¼ˆchunksï¼‰ã€‚æ¯ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨äº†ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚React æ¸²æŸ“æ—¶ï¼Œä¼šæŒ‰é¡ºåºéå† Fiber æ ‘ä¸­çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œä¸æ¯ä¸ªèŠ‚ç‚¹ç›¸å…³çš„å·¥ä½œã€‚\n![image.png](https://cdn.jsdelivr.net/gh/jenniferwonder/bimg/full-stack/react-fiber.png)\n\n#### Double Buffering (åŒç¼“å†²)\n\nReact åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªæ ‘ç»“æ„ï¼šå½“å‰çš„æ ‘å’Œæ­£åœ¨å·¥ä½œçš„æ ‘ã€‚è¿™ä½¿å¾— React å¯ä»¥åœ¨ç”¨æˆ·ä¸å¯è§çš„åœ°æ–¹è¿›è¡Œå·¥ä½œï¼Œå¹¶ä¸”åªæœ‰å½“å·¥ä½œå®Œæˆå¹¶ä¸”æ•´ä¸ªæ ‘éƒ½å‡†å¤‡å¥½æ›´æ–°æ—¶ï¼Œæ‰ä¼šè¿›è¡Œæäº¤ã€‚\n\n\x3c!-- ![diff](react-internal%201.md#^a7iagv) --\x3e\n\n#### Priority\n\n[react/packages/scheduler/src/SchedulerPriorities.js at main Â· facebook/react Â· GitHub](https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerPriorities.js)\n\n- Different types of updates have different priorities â€” an animation update needs to complete more quickly than, say, an update from a data store.\n- **Immediate Priority**ï¼šç”¨äºä¸èƒ½ç­‰å¾…çš„å·¥ä½œï¼Œæ¯”å¦‚ç”±ç”¨æˆ·è¾“å…¥æˆ–åŠ¨ç”»è§¦å‘çš„æ›´æ–°ã€‚\n- **User Blocking Priority**ï¼šç”¨äºå¯èƒ½é˜»å¡ç”¨æˆ·æ“ä½œçš„å·¥ä½œã€‚\n- **Normal Priority**ï¼šç”¨äºæ­£å¸¸çš„æ•°æ®æŠ“å–ã€DOM æ›´æ–°ç­‰ã€‚\n- **Low Priority**ï¼šç”¨äºä¸æ€¥è¿«çš„ä»»åŠ¡ï¼Œå¯ä»¥æ¨è¿Ÿçš„å·¥ä½œï¼Œå¦‚æ—¥å¿—è®°å½•ã€‚\n- **Idle Priority**ï¼šç”¨äºå®Œå…¨ä¸ç´§æ€¥çš„ä»»åŠ¡ï¼Œåªæœ‰åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰æ‰§è¡Œï¼Œå¦‚ç¦»å±æ¸²æŸ“ã€‚\n\n#### Scheduler (è°ƒåº¦å™¨) / Concurrent Mode (å¹¶å‘æ¨¡å¼)\n\n> it's not necessary for every update to be applied immediately\n\nUnlike a push-based approach which requires the app (you, the programmer) to decide how to schedule work. A pull-based approach allows the framework (React) to be smart and make those decisions for you.\n_scheduling_\nthe process of determining when work should be performed.\n_work_\nany computations that must be performed. Work is usually the result of an update (e.g.Â `setState`).\nÂ [here](https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js?source=post_page---------------------------#L29-L28)Â you can see all types of work targets in Fiber\n\n##### MessageChannel\n\n`MessageChannel`Â API å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ª`MessagePort`å±æ€§å‘é€æ•°æ®ã€‚åœ¨ React çš„ä»»åŠ¡è°ƒåº¦å™¨ä¸­ï¼Œä½¿ç”¨`MessageChannel`ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ç§å¯ä»¥è·¨æµè§ˆå™¨å’Œç¯å¢ƒæŒç»­è¿è¡Œçš„â€œå¾®ä»»åŠ¡â€è°ƒåº¦ã€‚\nä½¿ç”¨`MessageChannel`å¯ä»¥ä½¿å¾— React åœ¨å¤„ç†å¦‚è¾“å…¥äº‹ä»¶ä¹‹åå°½å¿«è°ƒåº¦æ›´æ–°ï¼Œå› ä¸ºå®ƒå¯ä»¥å°†ä»»åŠ¡æ’é˜Ÿä¸ºå¾®ä»»åŠ¡ï¼Œè¿™äº›å¾®ä»»åŠ¡å°†åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåå°½å¿«æ‰§è¡Œï¼Œä½†åœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡å¼€å§‹ä¹‹å‰æ‰§è¡Œ\n\n##### Time Slicingï¼ˆæ—¶é—´åˆ†ç‰‡ï¼‰\n\nReact ä½¿ç”¨æµè§ˆå™¨çš„`requestIdleCallback`å’Œ`requestAnimationFrame`API æ¥æ‰§è¡Œæ—¶é—´åˆ†ç‰‡ã€‚ä½¿ç”¨`requestIdleCallback`å¯ä»¥è®© React åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œè€Œ`requestAnimationFrame`åˆ™ç”¨äºé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œå¦‚åŠ¨ç”»ã€‚ ^u64q5e\nReact å°†æ›´æ–°åˆ†è§£æˆå°çš„ä»»åŠ¡å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡å•å…ƒåœ¨æ‰§è¡Œæ—¶éƒ½ä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å°†æ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨ã€‚è¿™æ ·å¯ä»¥è®© React åœ¨æ‰§è¡Œå¤§é‡å·¥ä½œæ—¶ä»ç„¶èƒ½å¤Ÿå“åº”ç”¨æˆ·çš„äº¤äº’ã€‚\n\n###### å®ç°åŠŸèƒ½\n\nnon-blocking rendering\napplying updates based on the priority\npre-rendering content in the background\n\n#### ä½¿ç”¨ Concurrent Mode\n\nä¸ºäº†å¯ç”¨ Concurrent Modeï¼Œä½ éœ€è¦ä½¿ç”¨`React.createRoot`ä»£æ›¿`ReactDOM.render`æ¥åˆ›å»ºæ ¹èŠ‚ç‚¹\n\n```jsx\nimport React from \"react\";\nimport ReactDOM from \"react-dom\";\nconst root = ReactDOM.createRoot(document.getElementById(\"root\"));\nroot.render(<App />);\n```\n\n#### [React Fiber å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/858)\n\n#### [è¯´è¯´ä½ å¯¹ Fiber æ¶æ„çš„ç†è§£](https://github.com/haizlin/fe-interview/issues/700)\n\n- [Inside Fiber: in-depth overview of the new reconciliation algorithm in React | by Max Koretskyi | React In Depth | Medium](https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e)\n- [in Depth-inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react](https://angularindepth.com/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react)\n- [in Depth-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree](https://angularindepth.com/posts/1007/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree)\n\n### React 18 æ‰¹å¤„ç†\n\nåœ¨ React 18 ä¸­ï¼Œè‡ªåŠ¨æ‰¹å¤„ç†è¢«æ‰©å±•åˆ°æ›´å¤šçš„åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š\n\n- **Promise çš„è§£å†³å’Œæ‹’ç»å¤„ç†ç¨‹åº**ï¼šåœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œä¾‹å¦‚ Promise é“¾æˆ– async/await å‡½æ•°ä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè‡ªåŠ¨æ‰¹å¤„ç†ã€‚\n- **setTimeout å’Œ setInterval å›è°ƒ**ï¼šä½¿ç”¨è¿™äº›å®šæ—¶å™¨å‡½æ•°çš„å›è°ƒä¸­çš„çŠ¶æ€æ›´æ–°ç°åœ¨ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚\n- **åŸç”Ÿäº‹ä»¶å¤„ç†ç¨‹åº**ï¼šåœ¨é React åˆæˆäº‹ä»¶çš„ç›‘å¬å™¨ä¸­è¿›è¡Œçš„çŠ¶æ€æ›´æ–°ä¹Ÿä¼šè¢«æ‰¹å¤„ç†ã€‚\n- **ä»»ä½•å…¶ä»–äº‹ä»¶å¾ªç¯ä¸­çš„äº‹ä»¶å¤„ç†**ï¼šå‡ ä¹æ‰€æœ‰çš„çŠ¶æ€æ›´æ–°ï¼Œä¸ç®¡å®ƒä»¬æ¥æºäºä»€ä¹ˆï¼Œåªè¦å®ƒä»¬åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ã€‚\n  React 18 æ‰¹å¤„ç†è‡ªåŠ¨æ‰¹å¤„ç†çš„å·¥ä½œåŸç†æ˜¯ React åœ¨æ‰§è¡Œæ›´æ–°æ—¶é‡‡ç”¨äº†ä¸€ç§æ‡’æƒ°çš„æ–¹å¼ï¼Œå®ƒä¼šå°†å¤šä¸ªæ›´æ–°ç´¯ç§¯èµ·æ¥ï¼Œç„¶åä¸€æ¬¡æ€§åº”ç”¨è¿™äº›æ›´æ–°ï¼Œè€Œä¸æ˜¯å¯¹æ¯ä¸ªæ›´æ–°ç«‹å³è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚è¿™å‡å°‘äº†é‡å¤çš„å·¥ä½œå’Œä¸å¿…è¦çš„ DOM æ›´æ–°ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚\n\n```jsx\n// å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªçŠ¶æ€æ›´æ–°å‡½æ•°\nconst [count, setCount] = useState(0);\nconst [flag, setFlag] = useState(false);\n// åœ¨ React 17 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šå¯¼è‡´ä¸¤æ¬¡é‡æ–°æ¸²æŸ“\nsetTimeout(() => {\n  setCount((c) => c + 1); // 1st re-render\n  setFlag((f) => !f); // 2nd re-render\n}, 1000);\n// åœ¨ React 18 ä¸­ï¼Œè¿™äº›æ›´æ–°ä¼šè¢«è‡ªåŠ¨æ‰¹å¤„ç†ä¸ºä¸€æ¬¡é‡æ–°æ¸²æŸ“\nsetTimeout(() => {\n  setCount((c) => c + 1); // Both updates are batched\n  setFlag((f) => !f); // into a single re-render\n}, 1000);\n```\n\n#### é€‰æ‹©æ€§æ‰¹å¤„ç†\n\nReact 18 æä¾›äº†Â `flushSync`Â å‡½æ•°ï¼Œå…è®¸ä½ é€‰æ‹©æ€§åœ°é€€å‡ºæ‰¹å¤„ç†ï¼Œå¯ä»¥ç¡®ä¿åœ¨å›è°ƒä¸­çš„æ›´æ–°ç«‹å³è¢«åº”ç”¨ï¼Œè§¦å‘åŒæ­¥çš„é‡æ–°æ¸²æŸ“\n\n```jsx\nimport { flushSync } from \"react-dom\";\n// åœ¨ flushSync çš„å›è°ƒä¸­çš„æ›´æ–°ä¸ä¼šæ‰¹å¤„ç†\nflushSync(() => {\n  setCount((c) => c + 1); // These updates are\n});\nflushSync(() => {\n  setFlag((f) => !f); // applied immediately\n});\n```\n\n## Questions\n\n#### [ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„ React å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ](https://github.com/haizlin/fe-interview/issues/611)\n\n#### [ä½ é˜…è¯»äº†å‡ é React çš„æºç ï¼Ÿéƒ½æœ‰å“ªäº›æ”¶è·ï¼Ÿä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/879)\n\n#### [ä½ é˜…è¯»è¿‡ React çš„æºç å—ï¼Ÿç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹](https://github.com/haizlin/fe-interview/issues/654)\n\n#### [React æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„ DOM å…ƒç´ ï¼Ÿ](https://github.com/haizlin/fe-interview/issues/663)\n\n#### è®²ä¸€ä¸‹ react çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯\n\n##### 1. çŠ¶æ€æ›´æ–°\n\nè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ä»ä¸€ä¸ªçŠ¶æ€æ›´æ–°å¼€å§‹ã€‚è¿™å¯èƒ½æ˜¯ç”±äºÂ `setState`ã€`useState`Â çš„ setter å‡½æ•°æˆ–Â `useReducer`Â çš„ dispatch è°ƒç”¨å¼•èµ·çš„ã€‚\nå½“çŠ¶æ€æ›´æ–°è¢«è§¦å‘æ—¶ï¼ŒReact ä¼šå°†è¯¥ç»„ä»¶æ ‡è®°ä¸ºéœ€è¦æ›´æ–°ã€‚\n\n##### 2. è°ƒåº¦æ›´æ–°\n\nReact çš„è°ƒåº¦å™¨æ¥æ”¶åˆ°æ›´æ–°è¯·æ±‚ï¼Œå¹¶æ ¹æ®å…¶ä¼˜å…ˆçº§å†³å®šä½•æ—¶æ‰§è¡Œæ›´æ–°ã€‚åœ¨ Concurrent Mode ä¸‹ï¼ŒReact å¯èƒ½ä¼šæ ¹æ®ä»»åŠ¡çš„ç´§æ€¥ç¨‹åº¦å’Œæµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ¥æ¨è¿Ÿæˆ–ä¸­æ–­æ›´æ–°ã€‚\n\n##### 3. åè°ƒï¼ˆReconciliationï¼‰\n\nåè°ƒè¿‡ç¨‹å¼€å§‹æ—¶ï¼ŒReact ä¼šä¸ºå½“å‰çš„æ›´æ–°åˆ›å»ºä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå¹¶å¼€å§‹éå†ç»„ä»¶æ ‘ï¼ˆä¹Ÿç§°ä¸º Fiber æ ‘ï¼‰ã€‚\n\n1. **æ¯”è¾ƒé˜¶æ®µ**ï¼šReact ä¼šæ¯”è¾ƒæ–°çš„ç»„ä»¶çŠ¶æ€å’Œä¸Šä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€ï¼Œè®¡ç®—å‡ºå®é™…éœ€è¦å˜æ›´çš„éƒ¨åˆ†ã€‚\n2. **ç”Ÿæˆ Fiber æ ‘**ï¼šReact ä¸ºæ¸²æŸ“ä¸­çš„æ¯ä¸ªç»„ä»¶åˆ›å»ºæˆ–æ›´æ–° Fiber èŠ‚ç‚¹ã€‚Fiber æ˜¯ React ç”¨äºè·Ÿè¸ªç»„ä»¶æ ‘ä¸­çš„æ¯ä¸ªç»„ä»¶çŠ¶æ€å’Œç»“æ„çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚\n\n##### 4. æ¸²æŸ“\n\nåœ¨åè°ƒè¿‡ç¨‹ä¸­ï¼ŒReact ä¸ºç»„ä»¶è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«æˆ–ç±»ç»„ä»¶çš„ `render` æ–¹æ³•ï¼‰ï¼Œç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOMï¼ˆReact å…ƒç´ ï¼‰ã€‚\n\n##### 5. æäº¤\n\nå½“åè°ƒå®Œæˆå¹¶ä¸” React å‡†å¤‡å¥½åº”ç”¨å˜æ›´åˆ°å®é™… DOM æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œæäº¤é˜¶æ®µã€‚\n\n1. **æ‰§è¡Œå‰¯ä½œç”¨**ï¼šåœ¨æäº¤é˜¶æ®µï¼ŒReact ä¼šæ‰§è¡Œ `useEffect`ã€`useLayoutEffect` ç­‰ Hook ä¸­çš„å‰¯ä½œç”¨å‡½æ•°ã€‚\n2. **æ›´æ–° DOM**ï¼šReact å°†æ›´æ–°è®¡ç®—å‡ºæ¥çš„å˜æ›´åº”ç”¨åˆ°å®é™…çš„ DOM ä¸Šã€‚è¿™å¯èƒ½åŒ…æ‹¬å±æ€§çš„æ›´æ–°ã€å…ƒç´ çš„æ·»åŠ æˆ–åˆ é™¤ç­‰ã€‚\n3. **å¼•ç”¨èµ‹å€¼**ï¼šReact ä¼šæ›´æ–°éœ€è¦å˜æ›´çš„ç»„ä»¶çš„å¼•ç”¨ï¼Œä¾‹å¦‚å°† DOM èŠ‚ç‚¹èµ‹å€¼ç»™é€šè¿‡ `useRef` åˆ›å»ºçš„ Refsã€‚\n\n##### 6. æ¸…ç†ä¸é€šçŸ¥\n\næœ€åï¼ŒReact æ¸…ç†ä¹‹å‰æ¸²æŸ“çš„çŠ¶æ€ã€æ‰§è¡Œå‰¯ä½œç”¨çš„æ¸…ç†å‡½æ•°ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šçŸ¥ç»„ä»¶æ›´æ–°å®Œæˆã€‚è¿™æ˜¯ä¸€ä¸ªæ¸…ç†å¹¶ä½¿ç³»ç»Ÿä¿æŒæœ€æ–°çŠ¶æ€çš„è¿‡ç¨‹ã€‚\n\n##### æ€è€ƒ\n\næ•´ä¸ªè¿‡ç¨‹æ˜¯é«˜åº¦ä¼˜åŒ–çš„ï¼Œæ¶‰åŠåˆ°äº†ä¸€ç³»åˆ—å¤æ‚çš„å†…éƒ¨æœºåˆ¶ã€‚React ä½¿ç”¨äº†å¦‚ Fiber æ¶æ„ã€åŒç¼“å†²ã€æ—¶é—´åˆ‡ç‰‡ç­‰æŠ€æœ¯ï¼Œä½¿å¾—å³ä½¿åœ¨å¤§è§„æ¨¡çš„æ›´æ–°ä¸­ä¹Ÿèƒ½ä¿æŒé«˜æ€§èƒ½å¹¶é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚\nåœ¨å®è·µä¸­ï¼ŒReact å¼€å‘è€…ä¸éœ€è¦æ·±å…¥äº†è§£æ‰€æœ‰å†…éƒ¨ç»†èŠ‚ï¼Œä½†ç†è§£çŠ¶æ€æ›´æ–°å’Œè§†å›¾æ›´æ–°ä¹‹é—´çš„åŸºæœ¬é“¾è·¯å¯¹äºç¼–å†™é«˜æ•ˆä¸”ç¬¦åˆé¢„æœŸçš„ä»£ç æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚\n"}function compiledContent(){return html}function getHeadings(){return[{depth:1,slug:"react-internal",text:"React Internal#"},{depth:2,slug:"reverse-engineering",text:"Reverse Engineering#"},{depth:2,slug:"fiber",text:"Fiber#"},{depth:3,slug:"what-is-fiber",text:"What is Fiber#"},{depth:4,slug:"why-this-name-fiber",text:"Why this name â€œFiberâ€#"},{depth:4,slug:"reconciliation",text:"Reconciliation#"},{depth:4,slug:"data-structure-list--tree",text:"Data Structure (List & Tree)#"},{depth:5,slug:"important-fields-of-a-fiber",text:"Important fields of a fiber#"},{depth:3,slug:"background",text:"Background#"},{depth:4,slug:"æ€æ‰‹çº§ç‰¹æ€§-killer-feature",text:"æ€æ‰‹çº§ç‰¹æ€§ (killer feature)#"},{depth:4,slug:"re-render",text:"Re-render#"},{depth:4,slug:"diff",text:"Diff#"},{depth:4,slug:"reconciliation--virtual-dom-è™šæ‹Ÿ-dom",text:"Reconciliation / Virtual DOM (è™šæ‹Ÿ DOM)#"},{depth:5,slug:"supports-dom-and-ios-android-via-react-native",text:"Supports DOM, and iOS, Android via React Native#"},{depth:5,slug:"ä½ çŸ¥é“-virtual-dom-çš„å·¥ä½œåŸç†å—",text:"ä½ çŸ¥é“ Virtual DOM çš„å·¥ä½œåŸç†å—ï¼Ÿ#"},{depth:5,slug:"pre-requisite",text:"Pre-requisite#"},{depth:5,slug:"reference",text:"Reference#"},{depth:5,slug:"questions",text:"Questions#"},{depth:3,slug:"goal-of-fiber",text:"Goal of Fiber#"},{depth:4,slug:"the-ability-to-pause-abort-or-reuse-work-as-new-updates-come-in",text:"the ability to pause, abort, or reuse work as new updates come in#"},{depth:4,slug:"the-ability-to-assign-priority-to-different-types-of-updates",text:"the ability to assign priority to different types of updates#"},{depth:3,slug:"how-fiber-works",text:"How Fiber works#"},{depth:4,slug:"comparison-with-old-reconciler",text:"Comparison with old reconciler#"},{depth:4,slug:"chunkingåˆ†åŒ…",text:"Chunkingï¼ˆåˆ†åŒ…ï¼‰#"},{depth:4,slug:"double-buffering-åŒç¼“å†²",text:"Double Buffering (åŒç¼“å†²)#"},{depth:4,slug:"priority",text:"Priority#"},{depth:4,slug:"scheduler-è°ƒåº¦å™¨--concurrent-mode-å¹¶å‘æ¨¡å¼",text:"Scheduler (è°ƒåº¦å™¨) / Concurrent Mode (å¹¶å‘æ¨¡å¼)#"},{depth:5,slug:"messagechannel",text:"MessageChannel#"},{depth:5,slug:"time-slicingæ—¶é—´åˆ†ç‰‡",text:"Time Slicingï¼ˆæ—¶é—´åˆ†ç‰‡ï¼‰#"},{depth:6,slug:"å®ç°åŠŸèƒ½",text:"å®ç°åŠŸèƒ½#"},{depth:4,slug:"ä½¿ç”¨-concurrent-mode",text:"ä½¿ç”¨ Concurrent Mode#"},{depth:4,slug:"react-fiber-å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜",text:"React Fiber å®ƒçš„ç›®çš„æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ#"},{depth:4,slug:"è¯´è¯´ä½ å¯¹-fiber-æ¶æ„çš„ç†è§£",text:"è¯´è¯´ä½ å¯¹ Fiber æ¶æ„çš„ç†è§£#"},{depth:3,slug:"react-18-æ‰¹å¤„ç†",text:"React 18 æ‰¹å¤„ç†#"},{depth:4,slug:"é€‰æ‹©æ€§æ‰¹å¤„ç†",text:"é€‰æ‹©æ€§æ‰¹å¤„ç†#"},{depth:2,slug:"questions-1",text:"Questions#"},{depth:4,slug:"ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„-react-å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ",text:"ç®€è¦æè¿°ä¸‹ä½ çŸ¥é“çš„ React å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ#"},{depth:4,slug:"ä½ é˜…è¯»äº†å‡ é-react-çš„æºç éƒ½æœ‰å“ªäº›æ”¶è·ä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„",text:"ä½ é˜…è¯»äº†å‡ é React çš„æºç ï¼Ÿéƒ½æœ‰å“ªäº›æ”¶è·ï¼Ÿä½ æ˜¯æ€ä¹ˆé˜…è¯»çš„ï¼Ÿ#"},{depth:4,slug:"ä½ é˜…è¯»è¿‡-react-çš„æºç å—ç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹",text:"ä½ é˜…è¯»è¿‡ React çš„æºç å—ï¼Ÿç®€è¦è¯´ä¸‹å®ƒçš„æ‰§è¡Œæµç¨‹#"},{depth:4,slug:"react-æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„-dom-å…ƒç´ ",text:"React æ€ä¹ˆæ‹¿åˆ°ç»„ä»¶å¯¹åº”çš„ DOM å…ƒç´ ï¼Ÿ#"},{depth:4,slug:"è®²ä¸€ä¸‹-react-çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯",text:"è®²ä¸€ä¸‹ react çŠ¶æ€å‘ç”Ÿå˜åŒ–è§¦å‘è§†å›¾æ›´æ–°çš„é“¾è·¯#"},{depth:5,slug:"1-çŠ¶æ€æ›´æ–°",text:"1. çŠ¶æ€æ›´æ–°#"},{depth:5,slug:"2-è°ƒåº¦æ›´æ–°",text:"2. è°ƒåº¦æ›´æ–°#"},{depth:5,slug:"3-åè°ƒreconciliation",text:"3. åè°ƒï¼ˆReconciliationï¼‰#"},{depth:5,slug:"4-æ¸²æŸ“",text:"4. æ¸²æŸ“#"},{depth:5,slug:"5-æäº¤",text:"5. æäº¤#"},{depth:5,slug:"6-æ¸…ç†ä¸é€šçŸ¥",text:"6. æ¸…ç†ä¸é€šçŸ¥#"},{depth:5,slug:"æ€è€ƒ",text:"æ€è€ƒ#"}]}const Content=createComponent(((e,n,t)=>{const{layout:a,...r}=frontmatter;return r.file=file,r.url=url,renderTemplate`${maybeRenderHead()}${unescapeHTML(html)}`})),reactInternal=Object.freeze(Object.defineProperty({__proto__:null,Content:Content,compiledContent:compiledContent,default:Content,file:file,frontmatter:frontmatter,getHeadings:getHeadings,rawContent:rawContent,url:url},Symbol.toStringTag,{value:"Module"}));export{_internal,body,collection,data,id,reactInternal,slug};